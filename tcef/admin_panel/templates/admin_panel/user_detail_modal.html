<!-- DEBUG: Verificar que el modal se est√° cargando -->
<script>
console.log('üîç MODAL CARGADO - user_detail_modal.html');
console.log('üìÖ Timestamp:', new Date().toISOString());
</script>

<!-- Header del modal con informaci√≥n del usuario -->
<div class="row mb-4">
    <div class="col-md-8">
        <h4 class="mb-1">
            <i class="fas fa-user me-2"></i>
            {{ user.get_full_name|default:user.username }}
        </h4>
        <p class="text-muted mb-0">{{ user.email }}</p>
        <small class="text-muted">
            <i class="fas fa-calendar me-1"></i>
            Usuario desde {{ user.date_joined|date:"d/m/Y" }}
        </small>
    </div>
    <div class="col-md-4">
        <div class="d-flex justify-content-end">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="changeMonth({{ user.id }}, {{ year }}, {{ month|add:'-1' }})">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button type="button" class="btn btn-primary btn-sm">
                    {{ month_date|date:"F Y" }}
                </button>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="changeMonth({{ user.id }}, {{ year }}, {{ month|add:'1' }})">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- T√≠tulo del mes actual -->
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info d-flex align-items-center" role="alert">
            <i class="fas fa-calendar-alt me-3 fa-2x"></i>
            <div>
                <h5 class="alert-heading mb-1">
                    <i class="fas fa-chart-line me-2"></i>
                    Progreso de {{ month_date|date:"F Y" }}
                </h5>
                <p class="mb-0">
                    Visualizando el progreso y m√©tricas de <strong>{{ user.get_full_name|default:user.username }}</strong> 
                    para el mes de <strong>{{ month_date|date:"F Y" }}</strong>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Estad√≠sticas generales -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stats-card">
            <h5><i class="fas fa-dumbbell me-2"></i>Ejercicios</h5>
            <div class="stat-item">
                <span class="stat-label">Este mes:</span>
                <span class="stat-value">{{ total_exercises }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Total:</span>
                <span class="stat-value">{{ total_exercises_all_time }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Progreso:</span>
                <span class="stat-value">{{ exercise_percentage }}%</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <h5><i class="fas fa-fire me-2"></i>Rachas</h5>
            <div class="stat-item">
                <span class="stat-label">Actual:</span>
                <span class="stat-value">{{ current_streak }} semanas</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Mejor:</span>
                <span class="stat-value">{{ best_streak }} semanas</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">D√≠as activo:</span>
                <span class="stat-value">{{ days_since_start }} d√≠as</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <h5><i class="fas fa-weight me-2"></i>Medidas</h5>
            {% if month_measurements %}
                {% with latest=month_measurements.first %}
                <div class="stat-item">
                    <span class="stat-label">Peso:</span>
                    <span class="stat-value">{{ latest.weight }} kg</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">IMC:</span>
                    <span class="stat-value">{{ latest.bmi }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Altura:</span>
                    <span class="stat-value">{{ latest.height }} cm</span>
                </div>
                {% endwith %}
            {% else %}
                <div class="text-muted">Sin medidas este mes</div>
            {% endif %}
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <h5><i class="fas fa-chart-pie me-2"></i>Composici√≥n</h5>
            {% if month_composition %}
                {% with latest=month_composition.first %}
                <div class="stat-item">
                    <span class="stat-label">% Grasa:</span>
                    <span class="stat-value">{{ latest.body_fat_percentage|default:"-" }}%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">M√∫sculo:</span>
                    <span class="stat-value">{{ latest.muscle_mass|default:"-" }} kg</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ICA:</span>
                    <span class="stat-value">{{ latest.ica|default:"-" }}</span>
                </div>
                {% endwith %}
            {% else %}
                <div class="text-muted">Sin datos este mes</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Calendario de ejercicios -->
<div class="row mb-4">
    <div class="col-12">
        <div class="stats-card">
            <h5><i class="fas fa-calendar-alt me-2"></i>Calendario de Ejercicios - {{ month_date|date:"F Y" }}</h5>
            <div class="calendar-grid">
                {% for day in "1234567890123456789012345678901"|make_list %}
                    {% if forloop.counter <= 31 %}
                        {% with day_num=forloop.counter %}
                            {% if day_num in exercise_dates %}
                                <div class="calendar-day exercise" title="Ejercicio completado el d√≠a {{ day_num }}">
                                    {{ day_num }}
                                </div>
                            {% else %}
                                <div class="calendar-day no-exercise" title="Sin ejercicio el d√≠a {{ day_num }}">
                                    {{ day_num }}
                                </div>
                            {% endif %}
                        {% endwith %}
                    {% endif %}
                {% endfor %}
            </div>
            <div class="mt-3">
                <small class="text-muted">
                    <span class="badge bg-success me-2">‚óè</span> Ejercicio completado
                    <span class="badge bg-light text-dark ms-3 me-2">‚óè</span> Sin ejercicio
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Gr√°fico de evoluci√≥n con selector -->
{% if weight_data or body_fat_data or muscle_data or ica_data %}
<div class="row">
    <div class="col-12">
        <div class="stats-card">
            <h5><i class="fas fa-chart-line me-2"></i>Evoluci√≥n de Medidas</h5>
            
            <!-- Selector de m√©trica -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <label for="metricSelector" class="form-label">M√©trica a Visualizar</label>
                    <select class="form-control" id="metricSelector" onchange="changeMetric()">
                        <option value="weight">Peso (kg)</option>
                        <option value="imc">IMC (√çndice de Masa Corporal)</option>
                        <option value="muscle_mass">Masa Muscular (kg)</option>
                        <option value="body_fat">% Grasa Corporal</option>
                        <option value="ica">ICA (√çndice Cintura-Altura)</option>
                    </select>
                    </div>
                <div class="col-md-3">
                    <label for="startDate" class="form-label">Fecha Inicio</label>
                    <input type="date" class="form-control" id="startDate" value="{{ first_measurement_date|date:'Y-m-d' }}">
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label">Fecha Fin</label>
                    <input type="date" class="form-control" id="endDate" value="{{ today_date|date:'Y-m-d' }}">
                    </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="button" class="btn btn-primary me-2" onclick="filterChart()">
                        <i class="fas fa-filter me-1"></i>Filtrar
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetChart()">
                        <i class="fas fa-undo me-1"></i>Reset
                    </button>
                </div>
            </div>
            
            <!-- Gr√°fico principal -->
            <div style="height: 400px; width: 100%; position: relative;">
                <canvas id="mainChart"></canvas>
            </div>
            
            <!-- Estad√≠sticas r√°pidas -->
            <div class="row mt-4">
                <div class="col-md-3 text-center">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title" id="currentMetricTitle">Valor Actual</h6>
                            <h4 class="text-primary" id="currentValue">--</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title" id="initialMetricTitle">Valor Inicial</h6>
                            <h4 class="text-info" id="initialValue">--</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title" id="differenceMetricTitle">Diferencia</h6>
                            <h4 class="text-success" id="differenceValue">--</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title" id="averageMetricTitle">Promedio</h6>
                            <h4 class="text-warning" id="averageValue">--</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Tabla de medidas detalladas -->
{% if month_measurements %}
<div class="row mt-4">
    <div class="col-12">
        <div class="stats-card">
            <h5><i class="fas fa-ruler me-2"></i>Medidas Detalladas</h5>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Peso (kg)</th>
                            <th>Altura (cm)</th>
                            <th>IMC</th>
                            <th>Cintura (cm)</th>
                            <th>Cadera (cm)</th>
                            <th>Cuello (cm)</th>
                            <th>Edad</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for measurement in month_measurements %}
                        <tr>
                            <td>{{ measurement.measurement_date|date:"d/m/Y" }}</td>
                            <td>{{ measurement.weight }}</td>
                            <td>{{ measurement.height }}</td>
                            <td>{{ measurement.bmi }}</td>
                            <td>{{ measurement.waist }}</td>
                            <td>{{ measurement.hip }}</td>
                            <td>{{ measurement.chest }}</td>
                            <td>{{ measurement.age }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Scripts para gr√°ficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
console.log('=== üöÄ INICIANDO SCRIPT DEL MODAL ===');
console.log('üìÖ Fecha y hora:', new Date().toLocaleString());
console.log('üåê User Agent:', navigator.userAgent);

// Datos de las medidas - con validaci√≥n mejorada
let weightDataRaw, muscleDataRaw, bodyFatDataRaw, icaDataRaw;

try {
    weightDataRaw = JSON.parse('{{ weight_data|escapejs }}');
} catch (e) {
    console.error('Error parsing weight_data:', e);
    weightDataRaw = [];
}

try {
    muscleDataRaw = JSON.parse('{{ muscle_data|escapejs }}');
} catch (e) {
    console.error('Error parsing muscle_data:', e);
    muscleDataRaw = [];
}

try {
    bodyFatDataRaw = JSON.parse('{{ body_fat_data|escapejs }}');
} catch (e) {
    console.error('Error parsing body_fat_data:', e);
    bodyFatDataRaw = [];
}

try {
    icaDataRaw = JSON.parse('{{ ica_data|escapejs }}');
} catch (e) {
    console.error('Error parsing ica_data:', e);
    icaDataRaw = [];
}

console.log('=== DEBUG DETALLADO DE DATOS ===');
console.log('üîç Verificando datos recibidos del servidor...');

// Debug del JSON crudo desde Django
console.log('üì¶ JSON CRUDO DESDE DJANGO:');
console.log('weight_data JSON crudo:', '{{ weight_data|escapejs }}');
console.log('muscle_data JSON crudo:', '{{ muscle_data|escapejs }}');
console.log('body_fat_data JSON crudo:', '{{ body_fat_data|escapejs }}');
console.log('ica_data JSON crudo:', '{{ ica_data|escapejs }}');

// Debug de los datos parseados
console.log('üìä DATOS PARSEADOS:');
console.log('weightDataRaw:', weightDataRaw);
console.log('muscleDataRaw:', muscleDataRaw);
console.log('bodyFatDataRaw:', bodyFatDataRaw);
console.log('icaDataRaw:', icaDataRaw);

// Debug de tipos y longitudes
console.log('üî¢ INFORMACI√ìN DE TIPOS Y LONGITUDES:');
console.log('- weightDataRaw:', {
    type: typeof weightDataRaw,
    length: weightDataRaw ? weightDataRaw.length : 'N/A',
    isArray: Array.isArray(weightDataRaw),
    firstItem: weightDataRaw && weightDataRaw.length > 0 ? weightDataRaw[0] : 'N/A'
});
console.log('- muscleDataRaw:', {
    type: typeof muscleDataRaw,
    length: muscleDataRaw ? muscleDataRaw.length : 'N/A',
    isArray: Array.isArray(muscleDataRaw),
    firstItem: muscleDataRaw && muscleDataRaw.length > 0 ? muscleDataRaw[0] : 'N/A'
});
console.log('- bodyFatDataRaw:', {
    type: typeof bodyFatDataRaw,
    length: bodyFatDataRaw ? bodyFatDataRaw.length : 'N/A',
    isArray: Array.isArray(bodyFatDataRaw),
    firstItem: bodyFatDataRaw && bodyFatDataRaw.length > 0 ? bodyFatDataRaw[0] : 'N/A'
});
console.log('- icaDataRaw:', {
    type: typeof icaDataRaw,
    length: icaDataRaw ? icaDataRaw.length : 'N/A',
    isArray: Array.isArray(icaDataRaw),
    firstItem: icaDataRaw && icaDataRaw.length > 0 ? icaDataRaw[0] : 'N/A'
});

// Validaci√≥n detallada de datos
console.log('‚úÖ VALIDACI√ìN DE DATOS:');
if (!weightDataRaw || weightDataRaw.length === 0) {
    console.warn('‚ö†Ô∏è No hay datos de peso disponibles');
} else {
    console.log('‚úÖ Datos de peso disponibles:', weightDataRaw.length, 'registros');
}

if (!muscleDataRaw || muscleDataRaw.length === 0) {
    console.warn('‚ö†Ô∏è No hay datos de masa muscular disponibles');
} else {
    console.log('‚úÖ Datos de masa muscular disponibles:', muscleDataRaw.length, 'registros');
}

if (!bodyFatDataRaw || bodyFatDataRaw.length === 0) {
    console.warn('‚ö†Ô∏è No hay datos de grasa corporal disponibles');
} else {
    console.log('‚úÖ Datos de grasa corporal disponibles:', bodyFatDataRaw.length, 'registros');
}

if (!icaDataRaw || icaDataRaw.length === 0) {
    console.warn('‚ö†Ô∏è No hay datos de ICA disponibles');
} else {
    console.log('‚úÖ Datos de ICA disponibles:', icaDataRaw.length, 'registros');
}

// Validar y procesar datos
const measurementsData = {
    labels: weightDataRaw ? weightDataRaw.map(d => d.date) : [],
    weights: weightDataRaw ? weightDataRaw.map(d => d.weight) : [],
    imcs: weightDataRaw ? weightDataRaw.map(d => d.bmi) : [],
    muscle_masses: muscleDataRaw ? muscleDataRaw.map(d => d.muscle) : [],
    body_fat_percentages: bodyFatDataRaw ? bodyFatDataRaw.map(d => d.body_fat) : [],
    icas: icaDataRaw ? icaDataRaw.map(d => d.ica) : []
};

console.log('measurementsData procesado:', measurementsData);

let mainChart = null;
let currentMetric = 'weight'; // M√©trica por defecto

// Configuraci√≥n de m√©tricas
const metricConfig = {
    weight: {
        label: 'Peso (kg)',
        color: '#007bff',
        backgroundColor: 'rgba(0, 123, 255, 0.1)',
        unit: 'kg',
        currentTitle: 'Peso Actual',
        initialTitle: 'Peso Inicial',
        differenceTitle: 'Diferencia',
        averageTitle: 'Promedio'
    },
    imc: {
        label: 'IMC',
        color: '#28a745',
        backgroundColor: 'rgba(40, 167, 69, 0.1)',
        unit: '',
        currentTitle: 'IMC Actual',
        initialTitle: 'IMC Inicial',
        differenceTitle: 'Diferencia',
        averageTitle: 'Promedio'
    },
    muscle_mass: {
        label: 'Masa Muscular (kg)',
        color: '#dc3545',
        backgroundColor: 'rgba(220, 53, 69, 0.1)',
        unit: 'kg',
        currentTitle: 'Masa Muscular Actual',
        initialTitle: 'Masa Muscular Inicial',
        differenceTitle: 'Diferencia',
        averageTitle: 'Promedio'
    },
    body_fat: {
        label: '% Grasa Corporal',
        color: '#ffc107',
        backgroundColor: 'rgba(255, 193, 7, 0.1)',
        unit: '%',
        currentTitle: '% Grasa Actual',
        initialTitle: '% Grasa Inicial',
        differenceTitle: 'Diferencia',
        averageTitle: 'Promedio'
    },
    ica: {
        label: 'ICA',
        color: '#6f42c1',
        backgroundColor: 'rgba(111, 66, 193, 0.1)',
        unit: '',
        currentTitle: 'ICA Actual',
        initialTitle: 'ICA Inicial',
        differenceTitle: 'Diferencia',
        averageTitle: 'Promedio'
    }
};

// Funci√≥n para inicializar el gr√°fico cuando el modal est√© visible
function initializeChart() {
    console.log('=== INICIALIZANDO GR√ÅFICO EN MODAL ===');
    
    // Verificar que Chart.js est√© disponible
    if (typeof Chart === 'undefined') {
        console.log('‚ùå Chart.js no est√° disponible, reintentando en 100ms...');
        setTimeout(initializeChart, 100);
        return;
    }
    
    // Verificar que el canvas existe
    const mainChartEl = document.getElementById('mainChart');
    if (!mainChartEl) {
        console.log('‚ùå Canvas mainChart no encontrado, reintentando...');
        setTimeout(initializeChart, 100);
        return;
    }
    
    console.log('‚úÖ Elementos disponibles, verificando datos...');
    
    // Verificar si hay datos disponibles
    const hasAnyData = measurementsData.labels && measurementsData.labels.length > 0;
    console.log('Has any data:', hasAnyData, 'Labels:', measurementsData.labels ? measurementsData.labels.length : 0);
    
    if (hasAnyData) {
        createMainChart();
        calculateStats();
    } else {
        showNoDataMessage();
    }
}

function showNoDataMessage() {
    console.log('Mostrando mensaje de sin datos');
    const canvasEl = document.getElementById('mainChart');
    if (canvasEl && canvasEl.parentElement) {
        canvasEl.parentElement.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No hay datos de m√©tricas</h5>
                <p class="text-muted">No se encontraron medidas para mostrar en este mes</p>
                <small class="text-muted">Los datos aparecer√°n cuando el usuario registre medidas corporales</small>
                <div class="mt-3">
                    <small class="text-info">
                        <i class="fas fa-info-circle me-1"></i>
                        Debug: weightDataRaw=${weightDataRaw ? weightDataRaw.length : 'null'}, 
                        muscleDataRaw=${muscleDataRaw ? muscleDataRaw.length : 'null'}
                    </small>
                </div>
            </div>
        `;
    }
}

// Funci√≥n para inicializar el gr√°fico cuando el modal est√© completamente visible
function initializeModalChart() {
    console.log('=== üöÄ INICIALIZANDO GR√ÅFICO EN MODAL ===');
    console.log('üîç Verificando disponibilidad de Chart.js...');
    
    // Verificar que Chart.js est√© disponible
    if (typeof Chart === 'undefined') {
        console.log('‚ùå Chart.js no est√° disponible, reintentando en 100ms...');
        setTimeout(initializeModalChart, 100);
        return;
    }
    console.log('‚úÖ Chart.js est√° disponible');
    
    // Verificar que el canvas existe
    const mainChartEl = document.getElementById('mainChart');
    if (!mainChartEl) {
        console.log('‚ùå Canvas mainChart no encontrado, reintentando...');
        setTimeout(initializeModalChart, 100);
        return;
    }
    console.log('‚úÖ Canvas mainChart encontrado');
    
    console.log('üîç Verificando datos disponibles...');
    console.log('measurementsData completo:', measurementsData);
    console.log('Labels disponibles:', measurementsData.labels ? measurementsData.labels.length : 0);
    console.log('Weights disponibles:', measurementsData.weights ? measurementsData.weights.length : 0);
    console.log('Muscle masses disponibles:', measurementsData.muscle_masses ? measurementsData.muscle_masses.length : 0);
    console.log('Body fat percentages disponibles:', measurementsData.body_fat_percentages ? measurementsData.body_fat_percentages.length : 0);
    console.log('ICAs disponibles:', measurementsData.icas ? measurementsData.icas.length : 0);
    
    // Verificar si hay datos disponibles
    const hasAnyData = measurementsData.labels && measurementsData.labels.length > 0;
    console.log('üìä ¬øHay datos disponibles?', hasAnyData);
    console.log('üìä N√∫mero de labels:', measurementsData.labels ? measurementsData.labels.length : 0);
    
    if (hasAnyData) {
        console.log('‚úÖ Datos disponibles, creando gr√°fico...');
        createMainChart();
        calculateStats();
    } else {
        console.log('‚ö†Ô∏è No hay datos, mostrando mensaje de sin datos...');
        showNoDataMessage();
    }
}

// Funci√≥n para ser llamada cuando el modal se abra
window.initializeUserDetailChart = function() {
    console.log('Modal abierto, inicializando gr√°fico...');
    // Peque√±o delay para asegurar que el modal est√© completamente visible
    setTimeout(initializeModalChart, 200);
};

function createMainChart() {
    console.log('=== üìä CREANDO GR√ÅFICO PRINCIPAL ===');
    
    const canvasEl = document.getElementById('mainChart');
    if (!canvasEl) {
        console.log('‚ùå Canvas no encontrado');
        return;
    }
    console.log('‚úÖ Canvas encontrado');
    
    const ctx = canvasEl.getContext('2d');
    console.log('‚úÖ Contexto del canvas obtenido');
    
    // Verificar si hay datos disponibles
    const hasData = measurementsData.labels && measurementsData.labels.length > 0;
    console.log('üîç Verificando datos:');
    console.log('- ¬øHay datos?', hasData);
    console.log('- Labels count:', measurementsData.labels ? measurementsData.labels.length : 0);
    console.log('- Labels:', measurementsData.labels);
    
    if (!hasData) {
        console.log('‚ö†Ô∏è No hay datos disponibles, mostrando placeholder');
        canvasEl.parentElement.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No hay datos de m√©tricas</h5>
                <p class="text-muted">No se encontraron medidas para mostrar en este mes</p>
                <small class="text-muted">Los datos aparecer√°n cuando el usuario registre medidas corporales</small>
            </div>
        `;
        return;
    }
    
    const config = metricConfig[currentMetric];
    const data = getCurrentMetricData();
    
    console.log('üîß Configuraci√≥n del gr√°fico:');
    console.log('- M√©trica actual:', currentMetric);
    console.log('- Config:', config);
    console.log('- Datos para el gr√°fico:', data);
    console.log('- N√∫mero de puntos de datos:', data.length);
    
    try {
        console.log('üöÄ Creando instancia de Chart.js...');
        mainChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: measurementsData.labels,
                datasets: [{
                    label: config.label,
                    data: data,
                    borderColor: config.color,
                    backgroundColor: config.backgroundColor,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: { size: 14, weight: 'bold' }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        titleFont: { size: 18, weight: 'bold' },
                        bodyFont: { size: 16 },
                        padding: 16,
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: config.color,
                        borderWidth: 2,
                        cornerRadius: 8
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Fecha',
                            font: { size: 14, weight: 'bold' }
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: config.label,
                            font: { size: 14, weight: 'bold' }
                        }
                    }
                }
            }
        });
        
        console.log('‚úÖ ¬°Gr√°fico creado exitosamente!');
        console.log('üìä Instancia del gr√°fico:', mainChart);
    } catch (error) {
        console.error('‚ùå Error creando el gr√°fico:', error);
        console.error('‚ùå Stack trace:', error.stack);
        canvasEl.parentElement.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                <h5 class="text-warning">Error al crear el gr√°fico</h5>
                <p class="text-muted">${error.message}</p>
            </div>
        `;
    }
}

function getCurrentMetricData() {
    console.log('üîç Obteniendo datos para la m√©trica:', currentMetric);
    
    let data = [];
    switch(currentMetric) {
        case 'weight':
            data = measurementsData.weights;
            console.log('üìä Datos de peso:', data);
            break;
        case 'imc':
            data = measurementsData.imcs;
            console.log('üìä Datos de IMC:', data);
            break;
        case 'muscle_mass':
            data = measurementsData.muscle_masses;
            console.log('üìä Datos de masa muscular:', data);
            break;
        case 'body_fat':
            data = measurementsData.body_fat_percentages;
            console.log('üìä Datos de grasa corporal:', data);
            break;
        case 'ica':
            data = measurementsData.icas;
            console.log('üìä Datos de ICA:', data);
            break;
        default:
            data = measurementsData.weights;
            console.log('üìä Datos por defecto (peso):', data);
    }
    
    console.log('‚úÖ Datos finales para el gr√°fico:', data);
    console.log('‚úÖ N√∫mero de puntos:', data ? data.length : 0);
    
    return data;
}

// Funciones globales para el modal - Sobrescribir las definiciones b√°sicas
window.changeMetric = function() {
    console.log('changeMetric called from modal');
    if (typeof currentMetric === 'undefined') {
        console.log('currentMetric no est√° definido, usando peso por defecto');
        currentMetric = 'weight';
    }
    
    const metricSelector = document.getElementById('metricSelector');
    if (metricSelector) {
        currentMetric = metricSelector.value;
    }
    
    if (typeof updateChart === 'function') {
        updateChart();
    } else {
        console.log('updateChart no est√° disponible');
    }
}

window.updateChart = function() {
    console.log('updateChart called from modal');
    if (!mainChart) {
        console.log('mainChart no est√° disponible');
        return;
    }
    
    const config = metricConfig[currentMetric];
    const data = getCurrentMetricData();
    
    mainChart.data.datasets[0].label = config.label;
    mainChart.data.datasets[0].data = data;
    mainChart.data.datasets[0].borderColor = config.color;
    mainChart.data.datasets[0].backgroundColor = config.backgroundColor;
    
    mainChart.options.scales.y.title.text = config.label;
    
    mainChart.update();
    
    // Actualizar t√≠tulos de estad√≠sticas
    const currentMetricTitle = document.getElementById('currentMetricTitle');
    const initialMetricTitle = document.getElementById('initialMetricTitle');
    const differenceMetricTitle = document.getElementById('differenceMetricTitle');
    const averageMetricTitle = document.getElementById('averageMetricTitle');
    
    if (currentMetricTitle) currentMetricTitle.textContent = config.currentTitle;
    if (initialMetricTitle) initialMetricTitle.textContent = config.initialTitle;
    if (differenceMetricTitle) differenceMetricTitle.textContent = config.differenceTitle;
    if (averageMetricTitle) averageMetricTitle.textContent = config.averageTitle;
    
    // Recalcular estad√≠sticas
    if (typeof calculateStats === 'function') {
        calculateStats();
    }
}

window.filterChart = function() {
    console.log('filterChart called from modal');
    if (!mainChart) {
        console.log('mainChart no est√° disponible');
        return;
    }
    
    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');
    
    if (!startDate || !endDate || !startDate.value || !endDate.value) {
        console.log('Fechas no v√°lidas');
        return;
    }
    
    const start = new Date(startDate.value);
    const end = new Date(endDate.value);
    
    const filteredLabels = [];
    const filteredData = [];
    const currentData = getCurrentMetricData();
    
    measurementsData.labels.forEach((label, index) => {
        const labelDate = new Date(label);
        if (labelDate >= start && labelDate <= end) {
            filteredLabels.push(label);
            filteredData.push(currentData[index]);
        }
    });
    
    mainChart.data.labels = filteredLabels;
    mainChart.data.datasets[0].data = filteredData;
    mainChart.update();
}

window.resetChart = function() {
    console.log('resetChart called from modal');
    if (!mainChart) {
        console.log('mainChart no est√° disponible');
        return;
    }
    
    mainChart.data.labels = measurementsData.labels;
    mainChart.data.datasets[0].data = getCurrentMetricData();
    mainChart.update();
}

// Funci√≥n para setup de datos de prueba (si es necesaria)
window.setupTestData = function() {
    console.log('setupTestData called from user_detail_modal');
    // Esta funci√≥n puede ser implementada si se necesitan datos de prueba
    // Por ejemplo, crear datos de prueba para el gr√°fico
    return true;
}

// Asegurar que la funci√≥n est√© disponible inmediatamente
if (typeof window.setupTestData !== 'function') {
    window.setupTestData = function() {
        console.log('setupTestData fallback called');
        return true;
    };
}

function calculateStats() {
    console.log('Calculating stats...');
    const currentData = getCurrentMetricData();
    const config = metricConfig[currentMetric];
    
    console.log('Current data for stats:', currentData);
    console.log('Config for stats:', config);
    
    if (currentData.length === 0) {
        console.log('No data available for stats');
        return;
    }
    
    const current = currentData[currentData.length - 1];
    const initial = currentData[0];
    const difference = current - initial;
    const average = currentData.reduce((a, b) => a + b, 0) / currentData.length;
    
    console.log('Stats calculated:', { current, initial, difference, average });
    
    const unit = config.unit;
    
    // Verificar que los elementos existen
    const currentEl = document.getElementById('currentValue');
    const initialEl = document.getElementById('initialValue');
    const differenceEl = document.getElementById('differenceValue');
    const averageEl = document.getElementById('averageValue');
    
    console.log('Scorecard elements:', {
        currentEl: !!currentEl,
        initialEl: !!initialEl,
        differenceEl: !!differenceEl,
        averageEl: !!averageEl
    });
    
    if (currentEl) currentEl.textContent = current.toFixed(1) + (unit ? ' ' + unit : '');
    if (initialEl) initialEl.textContent = initial.toFixed(1) + (unit ? ' ' + unit : '');
    if (differenceEl) differenceEl.textContent = (difference >= 0 ? '+' : '') + difference.toFixed(1) + (unit ? ' ' + unit : '');
    if (averageEl) averageEl.textContent = average.toFixed(1) + (unit ? ' ' + unit : '');
    
    console.log('Stats updated successfully');
}

// Log final para verificar que el script se ejecut√≥ completamente
console.log('‚úÖ SCRIPT DEL MODAL COMPLETADO');
console.log('üìä Variables disponibles:');
console.log('- weightDataRaw:', typeof weightDataRaw, weightDataRaw ? weightDataRaw.length : 'N/A');
console.log('- muscleDataRaw:', typeof muscleDataRaw, muscleDataRaw ? muscleDataRaw.length : 'N/A');
console.log('- measurementsData:', typeof measurementsData);
console.log('- initializeUserDetailChart:', typeof window.initializeUserDetailChart);

</script>
