
<!-- Header del modal con información del usuario -->
<div class="row mb-4">
    <div class="col-md-8">
        <h4 class="mb-1">
            <i class="fas fa-user me-2"></i>
            {{ user.get_full_name|default:user.username }}
        </h4>
        <p class="text-muted mb-0">{{ user.email }}</p>
        <small class="text-muted">
            <i class="fas fa-calendar me-1"></i>
            Usuario desde {{ user.date_joined|date:"d/m/Y" }}
        </small>
    </div>
    <div class="col-md-4">
        <div class="d-flex justify-content-end">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="changeMonth({{ user.id }}, {{ year }}, {{ month|add:'-1' }})">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button type="button" class="btn btn-primary btn-sm">
                    {{ month_date|date:"F Y" }}
                </button>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="changeMonth({{ user.id }}, {{ year }}, {{ month|add:'1' }})">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Título del mes actual -->
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info d-flex align-items-center" role="alert">
            <i class="fas fa-calendar-alt me-3 fa-2x"></i>
            <div>
                <h5 class="alert-heading mb-1">
                    <i class="fas fa-chart-line me-2"></i>
                    Progreso de {{ month_date|date:"F Y" }}
                </h5>
                <p class="mb-0">
                    Visualizando el progreso y métricas de <strong>{{ user.get_full_name|default:user.username }}</strong> 
                    para el mes de <strong>{{ month_date|date:"F Y" }}</strong>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Estadísticas generales -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stats-card">
            <h5><i class="fas fa-dumbbell me-2"></i>Ejercicios</h5>
            <div class="stat-item">
                <span class="stat-label">Este mes:</span>
                <span class="stat-value">{{ total_exercises }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Total:</span>
                <span class="stat-value">{{ total_exercises_all_time }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Progreso:</span>
                <span class="stat-value">{{ exercise_percentage }}%</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <h5><i class="fas fa-fire me-2"></i>Rachas</h5>
            <div class="stat-item">
                <span class="stat-label">Actual:</span>
                <span class="stat-value">{{ current_streak }} semanas</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Mejor:</span>
                <span class="stat-value">{{ best_streak }} semanas</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Días activo:</span>
                <span class="stat-value">{{ days_since_start }} días</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <h5><i class="fas fa-weight me-2"></i>Medidas</h5>
            {% if month_measurements %}
                {% with latest=month_measurements.first %}
                <div class="stat-item">
                    <span class="stat-label">Peso:</span>
                    <span class="stat-value">{{ latest.weight }} kg</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">IMC:</span>
                    <span class="stat-value">{{ latest.bmi }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Altura:</span>
                    <span class="stat-value">{{ latest.height }} cm</span>
                </div>
                {% endwith %}
            {% else %}
                <div class="text-muted">Sin medidas este mes</div>
            {% endif %}
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <h5><i class="fas fa-chart-pie me-2"></i>Composición</h5>
            {% if month_composition %}
                {% with latest=month_composition.first %}
                <div class="stat-item">
                    <span class="stat-label">% Grasa:</span>
                    <span class="stat-value">{{ latest.body_fat_percentage|default:"-" }}%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Músculo:</span>
                    <span class="stat-value">{{ latest.muscle_mass|default:"-" }} kg</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ICA:</span>
                    <span class="stat-value">{{ latest.ica|default:"-" }}</span>
                </div>
                {% endwith %}
            {% else %}
                <div class="text-muted">Sin datos este mes</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Calendario de ejercicios -->
<div class="row mb-4">
    <div class="col-12">
        <div class="stats-card">
            <h5><i class="fas fa-calendar-alt me-2"></i>Calendario de Ejercicios - {{ month_date|date:"F Y" }}</h5>
            <div class="calendar-grid">
                {% for day in "1234567890123456789012345678901"|make_list %}
                    {% if forloop.counter <= 31 %}
                        {% with day_num=forloop.counter %}
                            {% if day_num in exercise_dates %}
                                <div class="calendar-day exercise" title="Ejercicio completado el día {{ day_num }}">
                                    {{ day_num }}
                                </div>
                            {% else %}
                                <div class="calendar-day no-exercise" title="Sin ejercicio el día {{ day_num }}">
                                    {{ day_num }}
                                </div>
                            {% endif %}
                        {% endwith %}
                    {% endif %}
                {% endfor %}
            </div>
            <div class="mt-3">
                <small class="text-muted">
                    <span class="badge bg-success me-2">●</span> Ejercicio completado
                    <span class="badge bg-light text-dark ms-3 me-2">●</span> Sin ejercicio
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Gráfico de evolución con selector -->
{% if weight_data or body_fat_data or muscle_data or ica_data %}
<div class="row">
    <div class="col-12">
        <div class="stats-card">
            <h5><i class="fas fa-chart-line me-2"></i>Evolución de Medidas</h5>
            
            <!-- Selector de métrica -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <label for="metricSelector" class="form-label">Métrica a Visualizar</label>
                    <select class="form-control" id="metricSelector" onchange="changeMetric()">
                        <option value="weight">Peso (kg)</option>
                        <option value="imc">IMC (Índice de Masa Corporal)</option>
                        <option value="muscle_mass">Masa Muscular (kg)</option>
                        <option value="body_fat">% Grasa Corporal</option>
                        <option value="ica">ICA (Índice Cintura-Altura)</option>
                    </select>
                    </div>
                <div class="col-md-3">
                    <label for="startDate" class="form-label">Fecha Inicio</label>
                    <input type="date" class="form-control" id="startDate" value="{{ first_measurement_date|date:'Y-m-d' }}">
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label">Fecha Fin</label>
                    <input type="date" class="form-control" id="endDate" value="{{ today_date|date:'Y-m-d' }}">
                    </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="button" class="btn btn-primary me-2" onclick="filterChart()">
                        <i class="fas fa-filter me-1"></i>Filtrar
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetChart()">
                        <i class="fas fa-undo me-1"></i>Reset
                    </button>
                </div>
            </div>
            
            <!-- Gráfico principal -->
            <div style="height: 400px; width: 100%; position: relative;">
                <canvas id="mainChart"></canvas>
            </div>
            
            <!-- Estadísticas rápidas -->
            <div class="row mt-4">
                <div class="col-md-3 text-center">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title" id="currentMetricTitle">Valor Actual</h6>
                            <h4 class="text-primary" id="currentValue">--</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title" id="initialMetricTitle">Valor Inicial</h6>
                            <h4 class="text-info" id="initialValue">--</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title" id="differenceMetricTitle">Diferencia</h6>
                            <h4 class="text-success" id="differenceValue">--</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title" id="averageMetricTitle">Promedio</h6>
                            <h4 class="text-warning" id="averageValue">--</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Tabla de medidas detalladas -->
{% if month_measurements %}
<div class="row mt-4">
    <div class="col-12">
        <div class="stats-card">
            <h5><i class="fas fa-ruler me-2"></i>Medidas Detalladas</h5>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Peso (kg)</th>
                            <th>Altura (cm)</th>
                            <th>IMC</th>
                            <th>Cintura (cm)</th>
                            <th>Cadera (cm)</th>
                            <th>Cuello (cm)</th>
                            <th>Edad</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for measurement in month_measurements %}
                        <tr>
                            <td>{{ measurement.measurement_date|date:"d/m/Y" }}</td>
                            <td>{{ measurement.weight }}</td>
                            <td>{{ measurement.height }}</td>
                            <td>{{ measurement.bmi }}</td>
                            <td>{{ measurement.waist }}</td>
                            <td>{{ measurement.hip }}</td>
                            <td>{{ measurement.chest }}</td>
                            <td>{{ measurement.age }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Scripts para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>

// Datos de las medidas - con validación mejorada
let weightDataRaw, muscleDataRaw, bodyFatDataRaw, icaDataRaw;

try {
    weightDataRaw = JSON.parse('{{ weight_data|escapejs }}');
} catch (e) {
    console.error('Error parsing weight_data:', e);
    weightDataRaw = [];
}

try {
    muscleDataRaw = JSON.parse('{{ muscle_data|escapejs }}');
} catch (e) {
    console.error('Error parsing muscle_data:', e);
    muscleDataRaw = [];
}

try {
    bodyFatDataRaw = JSON.parse('{{ body_fat_data|escapejs }}');
} catch (e) {
    console.error('Error parsing body_fat_data:', e);
    bodyFatDataRaw = [];
}

try {
    icaDataRaw = JSON.parse('{{ ica_data|escapejs }}');
} catch (e) {
    console.error('Error parsing ica_data:', e);
    icaDataRaw = [];
}


// Validar y procesar datos
const measurementsData = {
    labels: weightDataRaw ? weightDataRaw.map(d => d.date) : [],
    weights: weightDataRaw ? weightDataRaw.map(d => d.weight) : [],
    imcs: weightDataRaw ? weightDataRaw.map(d => d.bmi) : [],
    muscle_masses: muscleDataRaw ? muscleDataRaw.map(d => d.muscle) : [],
    body_fat_percentages: bodyFatDataRaw ? bodyFatDataRaw.map(d => d.body_fat) : [],
    icas: icaDataRaw ? icaDataRaw.map(d => d.ica) : []
};


let mainChart = null;
let currentMetric = 'weight'; // Métrica por defecto

// Configuración de métricas
const metricConfig = {
    weight: {
        label: 'Peso (kg)',
        color: '#007bff',
        backgroundColor: 'rgba(0, 123, 255, 0.1)',
        unit: 'kg',
        currentTitle: 'Peso Actual',
        initialTitle: 'Peso Inicial',
        differenceTitle: 'Diferencia',
        averageTitle: 'Promedio'
    },
    imc: {
        label: 'IMC',
        color: '#28a745',
        backgroundColor: 'rgba(40, 167, 69, 0.1)',
        unit: '',
        currentTitle: 'IMC Actual',
        initialTitle: 'IMC Inicial',
        differenceTitle: 'Diferencia',
        averageTitle: 'Promedio'
    },
    muscle_mass: {
        label: 'Masa Muscular (kg)',
        color: '#dc3545',
        backgroundColor: 'rgba(220, 53, 69, 0.1)',
        unit: 'kg',
        currentTitle: 'Masa Muscular Actual',
        initialTitle: 'Masa Muscular Inicial',
        differenceTitle: 'Diferencia',
        averageTitle: 'Promedio'
    },
    body_fat: {
        label: '% Grasa Corporal',
        color: '#ffc107',
        backgroundColor: 'rgba(255, 193, 7, 0.1)',
        unit: '%',
        currentTitle: '% Grasa Actual',
        initialTitle: '% Grasa Inicial',
        differenceTitle: 'Diferencia',
        averageTitle: 'Promedio'
    },
    ica: {
        label: 'ICA',
        color: '#6f42c1',
        backgroundColor: 'rgba(111, 66, 193, 0.1)',
        unit: '',
        currentTitle: 'ICA Actual',
        initialTitle: 'ICA Inicial',
        differenceTitle: 'Diferencia',
        averageTitle: 'Promedio'
    }
};

// Función para inicializar el gráfico cuando el modal esté visible
function initializeChart() {
    console.log('=== INICIALIZANDO GRÁFICO EN MODAL ===');
    
    // Verificar que Chart.js esté disponible
    if (typeof Chart === 'undefined') {
        console.log('❌ Chart.js no está disponible, reintentando en 100ms...');
        setTimeout(initializeChart, 100);
        return;
    }
    
    // Verificar que el canvas existe
    const mainChartEl = document.getElementById('mainChart');
    if (!mainChartEl) {
        console.log('❌ Canvas mainChart no encontrado, reintentando...');
        setTimeout(initializeChart, 100);
        return;
    }
    
    console.log('✅ Elementos disponibles, verificando datos...');
    
    // Verificar si hay datos disponibles
    const hasAnyData = measurementsData.labels && measurementsData.labels.length > 0;
    console.log('Has any data:', hasAnyData, 'Labels:', measurementsData.labels ? measurementsData.labels.length : 0);
    
    if (hasAnyData) {
        createMainChart();
        calculateStats();
    } else {
        showNoDataMessage();
    }
}

function showNoDataMessage() {
    console.log('Mostrando mensaje de sin datos');
    const canvasEl = document.getElementById('mainChart');
    if (canvasEl && canvasEl.parentElement) {
        canvasEl.parentElement.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No hay datos de métricas</h5>
                <p class="text-muted">No se encontraron medidas para mostrar en este mes</p>
                <small class="text-muted">Los datos aparecerán cuando el usuario registre medidas corporales</small>
                <div class="mt-3">
                    <small class="text-info">
                        <i class="fas fa-info-circle me-1"></i>
                        Debug: weightDataRaw=${weightDataRaw ? weightDataRaw.length : 'null'}, 
                        muscleDataRaw=${muscleDataRaw ? muscleDataRaw.length : 'null'}
                    </small>
                </div>
            </div>
        `;
    }
}

// Función para inicializar el gráfico cuando el modal esté completamente visible
function initializeModalChart() {
    // Verificar que Chart.js esté disponible
    if (typeof Chart === 'undefined') {
        setTimeout(initializeModalChart, 100);
        return;
    }
    
    // Verificar que el canvas existe
    const mainChartEl = document.getElementById('mainChart');
    if (!mainChartEl) {
        setTimeout(initializeModalChart, 100);
        return;
    }
    
    // IMPORTANTE: Destruir el gráfico anterior si existe
    if (typeof mainChart !== 'undefined' && mainChart !== null) {
        mainChart.destroy();
        mainChart = null;
    }
    
    // Verificar si hay datos disponibles
    const hasAnyData = measurementsData.labels && measurementsData.labels.length > 0;
    
    if (hasAnyData) {
        createMainChart();
        calculateStats();
    } else {
        showNoDataMessage();
    }
}

// Función para ser llamada cuando el modal se abra
window.initializeUserDetailChart = function() {
    // Pequeño delay para asegurar que el modal esté completamente visible
    setTimeout(initializeModalChart, 200);
};

function createMainChart() {
    const canvasEl = document.getElementById('mainChart');
    if (!canvasEl) {
        return;
    }
    
    const ctx = canvasEl.getContext('2d');
    
    // Verificar si hay datos disponibles
    const hasData = measurementsData.labels && measurementsData.labels.length > 0;
    
    if (!hasData) {
        canvasEl.parentElement.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No hay datos de métricas</h5>
                <p class="text-muted">No se encontraron medidas para mostrar en este mes</p>
                <small class="text-muted">Los datos aparecerán cuando el usuario registre medidas corporales</small>
            </div>
        `;
        return;
    }
    
    const config = metricConfig[currentMetric];
    const data = getCurrentMetricData();
    
    try {
        mainChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: measurementsData.labels,
                datasets: [{
                    label: config.label,
                    data: data,
                    borderColor: config.color,
                    backgroundColor: config.backgroundColor,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: { size: 14, weight: 'bold' }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        titleFont: { size: 18, weight: 'bold' },
                        bodyFont: { size: 16 },
                        padding: 16,
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: config.color,
                        borderWidth: 2,
                        cornerRadius: 8
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Fecha',
                            font: { size: 14, weight: 'bold' }
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: config.label,
                            font: { size: 14, weight: 'bold' }
                        }
                    }
                }
            }
        });
    } catch (error) {
        canvasEl.parentElement.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                <h5 class="text-warning">Error al crear el gráfico</h5>
                <p class="text-muted">${error.message}</p>
            </div>
        `;
    }
}

function getCurrentMetricData() {
    let data = [];
    switch(currentMetric) {
        case 'weight':
            data = measurementsData.weights;
            break;
        case 'imc':
            data = measurementsData.imcs;
            break;
        case 'muscle_mass':
            data = measurementsData.muscle_masses;
            break;
        case 'body_fat':
            data = measurementsData.body_fat_percentages;
            break;
        case 'ica':
            data = measurementsData.icas;
            break;
        default:
            data = measurementsData.weights;
    }
    
    return data;
}

// Funciones globales para el modal - Sobrescribir las definiciones básicas
window.changeMetric = function() {
    if (typeof currentMetric === 'undefined') {
        currentMetric = 'weight';
    }
    
    const metricSelector = document.getElementById('metricSelector');
    if (metricSelector) {
        currentMetric = metricSelector.value;
    }
    
    if (typeof updateChart === 'function') {
        updateChart();
    }
}

window.updateChart = function() {
    if (!mainChart) {
        return;
    }
    
    const config = metricConfig[currentMetric];
    const data = getCurrentMetricData();
    
    mainChart.data.datasets[0].label = config.label;
    mainChart.data.datasets[0].data = data;
    mainChart.data.datasets[0].borderColor = config.color;
    mainChart.data.datasets[0].backgroundColor = config.backgroundColor;
    
    mainChart.options.scales.y.title.text = config.label;
    
    mainChart.update();
    
    // Actualizar títulos de estadísticas
    const currentMetricTitle = document.getElementById('currentMetricTitle');
    const initialMetricTitle = document.getElementById('initialMetricTitle');
    const differenceMetricTitle = document.getElementById('differenceMetricTitle');
    const averageMetricTitle = document.getElementById('averageMetricTitle');
    
    if (currentMetricTitle) currentMetricTitle.textContent = config.currentTitle;
    if (initialMetricTitle) initialMetricTitle.textContent = config.initialTitle;
    if (differenceMetricTitle) differenceMetricTitle.textContent = config.differenceTitle;
    if (averageMetricTitle) averageMetricTitle.textContent = config.averageTitle;
    
    // Recalcular estadísticas
    if (typeof calculateStats === 'function') {
        calculateStats();
    }
}

window.filterChart = function() {
    if (!mainChart) {
        return;
    }
    
    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');
    
    if (!startDate || !endDate || !startDate.value || !endDate.value) {
        return;
    }
    
    const start = new Date(startDate.value);
    const end = new Date(endDate.value);
    
    const filteredLabels = [];
    const filteredData = [];
    const currentData = getCurrentMetricData();
    
    measurementsData.labels.forEach((label, index) => {
        const labelDate = new Date(label);
        if (labelDate >= start && labelDate <= end) {
            filteredLabels.push(label);
            filteredData.push(currentData[index]);
        }
    });
    
    mainChart.data.labels = filteredLabels;
    mainChart.data.datasets[0].data = filteredData;
    mainChart.update();
}

window.resetChart = function() {
    if (!mainChart) {
        return;
    }
    
    mainChart.data.labels = measurementsData.labels;
    mainChart.data.datasets[0].data = getCurrentMetricData();
    mainChart.update();
}

// Función para setup de datos de prueba (si es necesaria)
window.setupTestData = function() {
    // Esta función puede ser implementada si se necesitan datos de prueba
    // Por ejemplo, crear datos de prueba para el gráfico
    return true;
}

// Asegurar que la función esté disponible inmediatamente
if (typeof window.setupTestData !== 'function') {
    window.setupTestData = function() {
        return true;
    };
}

function calculateStats() {
    const currentData = getCurrentMetricData();
    const config = metricConfig[currentMetric];
    
    if (currentData.length === 0) {
        return;
    }
    
    const current = currentData[currentData.length - 1];
    const initial = currentData[0];
    const difference = current - initial;
    const average = currentData.reduce((a, b) => a + b, 0) / currentData.length;
    
    const unit = config.unit;
    
    // Verificar que los elementos existen
    const currentEl = document.getElementById('currentValue');
    const initialEl = document.getElementById('initialValue');
    const differenceEl = document.getElementById('differenceValue');
    const averageEl = document.getElementById('averageValue');
    
    if (currentEl) currentEl.textContent = current.toFixed(1) + (unit ? ' ' + unit : '');
    if (initialEl) initialEl.textContent = initial.toFixed(1) + (unit ? ' ' + unit : '');
    if (differenceEl) differenceEl.textContent = (difference >= 0 ? '+' : '') + difference.toFixed(1) + (unit ? ' ' + unit : '');
    if (averageEl) averageEl.textContent = average.toFixed(1) + (unit ? ' ' + unit : '');
}


</script>
