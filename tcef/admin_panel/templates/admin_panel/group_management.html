{% extends 'admin_panel/base.html' %}

{% block title %}Gestión de Grupos - Panel de Administración{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-layer-group me-2"></i>
                Gestión de Grupos de Usuarios
            </h1>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                <i class="fas fa-plus me-2"></i>
                Crear Grupo
            </button>
        </div>
    </div>
</div>

<!-- Lista de grupos -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-list me-2"></i>
                    Grupos Existentes ({{ groups.count }} total)
                </h6>
            </div>
            <div class="card-body">
                {% if groups %}
                    <div class="row">
                        {% for group in groups %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">{{ group.name }}</h6>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" 
                                               {% if group.is_active %}checked{% endif %}
                                               onchange="toggleGroupStatus({{ group.id }}, this.checked)">
                                        <label class="form-check-label small">Activo</label>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">{{ group.description|default:"Sin descripción" }}</p>
                                    <div class="d-flex align-items-center mb-3">
                                        <span class="badge me-2" style="background-color: {{ group.color }}; color: white;">
                                            Color del grupo
                                        </span>
                                        <small class="text-muted">{{ group.get_member_count }} miembros</small>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            Creado: {{ group.created_at|date:"d/m/Y" }}
                                        </small>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                                    onclick="editGroup({{ group.id }}, '{{ group.name }}', '{{ group.description }}', '{{ group.color }}', {{ group.is_active|yesno:"true,false" }})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    onclick="deleteGroup({{ group.id }}, '{{ group.name }}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-layer-group fa-3x mb-3"></i>
                        <h5>No hay grupos creados</h5>
                        <p>Crea tu primer grupo para organizar a los usuarios</p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                            <i class="fas fa-plus me-2"></i>
                            Crear Primer Grupo
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear grupo -->
<div class="modal fade" id="createGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>
                    Crear Nuevo Grupo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="create">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="groupName" class="form-label">Nombre del Grupo *</label>
                        <input type="text" class="form-control" id="groupName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="groupDescription" class="form-label">Descripción</label>
                        <textarea class="form-control" id="groupDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="groupColor" class="form-label">Color del Grupo</label>
                        <input type="color" class="form-control form-control-color" id="groupColor" name="color" value="#007bff">
                        <div class="form-text">Elige un color para identificar visualmente este grupo</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>
                        Crear Grupo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para editar grupo -->
<div class="modal fade" id="editGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>
                    Editar Grupo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="update">
                <input type="hidden" name="group_id" id="editGroupId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editGroupName" class="form-label">Nombre del Grupo *</label>
                        <input type="text" class="form-control" id="editGroupName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editGroupDescription" class="form-label">Descripción</label>
                        <textarea class="form-control" id="editGroupDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editGroupColor" class="form-label">Color del Grupo</label>
                        <input type="color" class="form-control form-control-color" id="editGroupColor" name="color">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editGroupActive" name="is_active">
                            <label class="form-check-label" for="editGroupActive">
                                Grupo activo
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>
                        Actualizar Grupo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para eliminar grupo -->
<div class="modal fade" id="deleteGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que quieres eliminar el grupo <strong id="deleteGroupName"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Advertencia:</strong> Esta acción no se puede deshacer. 
                    Los usuarios en este grupo perderán su membresía.
                </div>
            </div>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="group_id" id="deleteGroupId">
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>
                        Eliminar Grupo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function editGroup(id, name, description, color, isActive) {
    document.getElementById('editGroupId').value = id;
    document.getElementById('editGroupName').value = name;
    document.getElementById('editGroupDescription').value = description;
    document.getElementById('editGroupColor').value = color;
    document.getElementById('editGroupActive').checked = isActive; // Set checkbox state
    
    const modal = new bootstrap.Modal(document.getElementById('editGroupModal'));
    modal.show();
}

function deleteGroup(id, name) {
    document.getElementById('deleteGroupId').value = id;
    document.getElementById('deleteGroupName').textContent = name;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteGroupModal'));
    modal.show();
}

function toggleGroupStatus(groupId, isActive) {
    // Enviar petición AJAX para actualizar el estado
    fetch('{% url "admin_panel:group_management" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `action=toggle&group_id=${groupId}&is_active=${isActive}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Mostrar mensaje de éxito
            showAlert(data.message, 'success');
        } else {
            // Revertir el toggle si falló
            const checkbox = event.target;
            checkbox.checked = !isActive;
            showAlert(data.error, 'danger');
        }
    })
    .catch(error => {
        // Revertir el toggle si falló
        const checkbox = event.target;
        checkbox.checked = !isActive;
        showAlert('Error al actualizar el estado del grupo', 'danger');
    });
}

function showAlert(message, type) {
    // Crear alerta Bootstrap
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insertar al inicio del contenido
    const content = document.querySelector('.container-fluid');
    content.insertBefore(alertDiv, content.firstChild);
    
    // Auto-remover después de 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %} 