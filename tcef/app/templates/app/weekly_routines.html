{% extends 'app/base.html' %}
{% load static %}

{% block title %}Rutinas Semanales - TCEF{% endblock %}

{% block content %}
<div class="container-fluid routines-container">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10 col-sm-12">
            
            <!-- Header de la página -->
            <div class="routines-header text-center mb-4">
                <h1 class="display-5 fw-bold" style="color: #dc6874;">
                    <i class="fas fa-dumbbell me-3"></i>Rutinas Semanales
                </h1>
                <p class="lead text-muted">Entrena cada día con rutinas personalizadas</p>
            </div>

            {% if current_routine %}
                <!-- Carrusel principal de rutinas -->
                <div class="routine-carousel">
                    
                    <!-- Indicador del día actual -->
                    <div class="day-indicator text-center mb-3">
                        <span class="badge" style="background-color: #dc6874;" fs-6 px-4 py-2">
                            <i class="fas fa-calendar-day me-2"></i>
                            {{ current_routine.get_day_display }}
                        </span>
                    </div>

                    <!-- Tarjeta principal de la rutina -->
                    <div class="routine-card">
                        <div class="routine-header">
                            <h2 class="routine-title">{{ current_routine.title }}</h2>
                            <div class="routine-meta">
                                <span class="duration">
                                    <i class="fas fa-clock me-1"></i>
                                    {{ current_routine.get_duration_formatted }}
                                </span>
                                <span class="difficulty">
                                    <i class="fas fa-fire me-1"></i>
                                    Rutina del día
                                </span>
                            </div>
                        </div>

                        <!-- Reproductor de video -->
                        <div class="video-container mb-4">
                            <video 
                                id="routine-video" 
                                class="routine-video" 
                                controls 
                                preload="metadata"
                                poster="{% static 'app/images/video-placeholder.jpg' %}"
                            >
                                <source src="{{ current_routine.video_url }}" type="video/mp4">
                                Tu navegador no soporta el elemento de video.
                            </video>
                        </div>

                        <!-- Descripción de la rutina -->
                        <div class="routine-description mb-4">
                            <h5><i class="fas fa-info-circle me-2"></i>Descripción:</h5>
                            <p class="text-muted">{{ current_routine.description }}</p>
                        </div>

                        <!-- Botón de completar rutina -->
                        <div class="routine-actions text-center">
                            {% if today_exercise %}
                                <div class="completed-badge mb-3">
                                    <span class="badge bg-success fs-6 px-4 py-2">
                                        <i class="fas fa-check-circle me-2"></i>
                                        ¡Rutina completada hoy!
                                    </span>
                                </div>
                                <p class="text-muted small">
                                    <i class="fas fa-calendar-check me-1"></i>
                                    Completada el {{ today_exercise.completed_at|date:"d/m/Y a las H:i" }}
                                </p>
                            {% else %}
                                <button 
                                    class="btn" style="background-color: #dc6874; border-color: #dc6874; color: white;"
                                    data-routine-day="{{ current_routine.day }}"
                                    data-routine-title="{{ current_routine.title }}"
                                >
                                    <i class="fas fa-check-circle me-2"></i>
                                    Marcar como Completada
                                </button>
                                <p class="text-muted small mt-2">
                                    Al completar la rutina se marcará automáticamente en tu calendario
                                </p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Navegación del carrusel -->
                    <div class="carousel-navigation d-flex justify-content-between align-items-center mt-4">
                        
                        <!-- Botón anterior -->
                        {% if previous_routine %}
                            <a href="{% url 'app:weekly_routines_day' previous_routine.day %}" 
                               class="btn" style="color: #dc6874; border-color: #dc6874; background-color: transparent;">
                                <i class="fas fa-chevron-left me-2"></i>
                                {{ previous_routine.get_day_display }}
                            </a>
                        {% else %}
                            <button class="btn btn-outline-secondary btn-lg" disabled>
                                <i class="fas fa-chevron-left me-2"></i>
                                Anterior
                            </button>
                        {% endif %}

                        <!-- Indicador de posición -->
                        <div class="carousel-position text-center">
                            <span class="text-muted">
                                {{ forloop.counter|default:1 }} de {{ all_routines.count }}
                            </span>
                        </div>

                        <!-- Botón siguiente -->
                        {% if next_routine %}
                            <a href="{% url 'app:weekly_routines_day' next_routine.day %}" 
                               class="btn" style="color: #dc6874; border-color: #dc6874; background-color: transparent;">
                                {{ next_routine.get_day_display }}
                                <i class="fas fa-chevron-right ms-2"></i>
                            </a>
                        {% else %}
                            <button class="btn btn-outline-secondary btn-lg" disabled>
                                Siguiente
                                <i class="fas fa-chevron-right ms-2"></i>
                            </button>
                        {% endif %}
                    </div>

                    <!-- Navegación rápida por días -->
                    <div class="quick-navigation mt-4">
                        <h6 class="text-center mb-3">
                            <i class="fas fa-calendar-week me-2"></i>
                            Navegación rápida
                        </h6>
                        <div class="days-grid d-flex justify-content-center flex-wrap gap-2">
                            {% for routine in all_routines %}
                                <a href="{% url 'app:weekly_routines_day' routine.day %}" 
                                   class="btn btn-sm {% if routine.day == current_day %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                    {{ routine.get_day_display|slice:":3" }}
                                </a>
                            {% endfor %}
                        </div>
                    </div>

                </div>

            {% else %}
                <!-- Mensaje cuando no hay rutinas disponibles -->
                <div class="no-routines text-center py-5">
                    <div class="no-routines-icon mb-4">
                        <i class="fas fa-video-slash fa-4x text-muted"></i>
                    </div>
                    <h3 class="text-muted">No hay rutinas disponibles</h3>
                    <p class="text-muted">Las rutinas para este día aún no han sido configuradas.</p>
                    <a href="/calendar/" class="btn" style="background-color: #dc6874; border-color: #dc6874; color: white;">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Ir al Calendario
                    </a>
                </div>
            {% endif %}

            <!-- Enlaces de navegación -->
            <div class="navigation-links text-center mt-5">
                <div class="row">
                    <div class="col-md-4">
                        <a href="{% url 'app:exercise_calendar' %}" class="btn" style="color: #dc6874; border-color: #dc6874; background-color: transparent; width: 100%;">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Ver Calendario
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{% url 'app:profile' %}" class="btn" style="color: #dc6874; border-color: #dc6874; background-color: transparent; width: 100%;">
                            <i class="fas fa-user me-2"></i>
                            Mi Perfil
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{% url 'app:exercise_stats' %}" class="btn" style="color: #dc6874; border-color: #dc6874; background-color: transparent; width: 100%;">
                            <i class="fas fa-chart-bar me-2"></i>
                            Estadísticas
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal de confirmación para completar rutina -->
<div class="modal fade" id="completeRoutineModal" tabindex="-1" aria-labelledby="completeRoutineModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="completeRoutineModalLabel">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    Confirmar Rutina Completada
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que quieres marcar la rutina de <strong id="routineDayTitle"></strong> como completada?</p>
                <p class="text-muted small">
                    <i class="fas fa-info-circle me-1"></i>
                    Esta acción se registrará en tu calendario de ejercicios.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" id="confirmCompleteRoutine">
                    <i class="fas fa-check me-1"></i>
                    Sí, Completada
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast de notificación -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="routineToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-check-circle text-success me-2"></i>
            <strong class="me-auto">TCEF</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            <!-- Mensaje del toast -->
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Variables globales
    let currentRoutineDay = '';
    let currentRoutineTitle = '';

    // Configurar botones de completar rutina
    const completeButtons = document.querySelectorAll('.complete-routine-btn');
    completeButtons.forEach(button => {
        button.addEventListener('click', function() {
            currentRoutineDay = this.dataset.routineDay;
            currentRoutineTitle = this.dataset.routineTitle;
            
            // Actualizar el modal
            document.getElementById('routineDayTitle').textContent = currentRoutineTitle;
            
            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('completeRoutineModal'));
            modal.show();
        });
    });

    // Confirmar completar rutina
    document.getElementById('confirmCompleteRoutine').addEventListener('click', function() {
        completeRoutine();
    });

    // Función para completar la rutina
    function completeRoutine() {
        const formData = new FormData();
        formData.append('routine_day', currentRoutineDay);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch('{% url "app:complete_routine" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar mensaje de éxito
                showToast(data.message, 'success');
                
                // Cerrar el modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('completeRoutineModal'));
                modal.hide();
                
                // Recargar la página para mostrar el estado actualizado
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showToast(data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error al completar la rutina', 'error');
        });
    }

    // Función para mostrar toast
    function showToast(message, type) {
        const toast = document.getElementById('routineToast');
        const toastMessage = document.getElementById('toastMessage');
        
        // Configurar el mensaje
        toastMessage.textContent = message;
        
        // Configurar el estilo según el tipo
        if (type === 'success') {
            toast.classList.remove('text-danger');
            toast.classList.add('text-success');
        } else {
            toast.classList.remove('text-success');
            toast.classList.add('text-danger');
        }
        
        // Mostrar el toast
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }

    // Configurar el video para autoplay (opcional)
    const video = document.getElementById('routine-video');
    if (video) {
        // Pausar el video cuando se cambia de página
        window.addEventListener('beforeunload', function() {
            video.pause();
        });
    }
});
</script>
{% endblock %} 