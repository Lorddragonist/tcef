{% extends 'app/base.html' %}
{% load static %}

{% block title %}Cambiar Contraseña - TCEF{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'app/css/password_change.css' %}">
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white text-center">
                <h3 class="mb-0">
                    <i class="fas fa-key me-2"></i>Cambiar Contraseña
                </h3>
                <p class="mb-0">Actualiza tu contraseña para mantener tu cuenta segura</p>
            </div>
            
            <div class="card-body p-4">
                <form method="post" novalidate>
                    {% csrf_token %}
                    
                    <!-- Contraseña actual -->
                    <div class="mb-3">
                        <label for="id_old_password" class="form-label">
                            <i class="fas fa-lock me-1"></i>Contraseña Actual
                        </label>
                        <div class="position-relative">
                            <input type="password" 
                                   name="old_password" 
                                   id="id_old_password" 
                                   class="form-control {% if form.old_password.errors %}is-invalid{% endif %}"
                                   placeholder="Ingresa tu contraseña actual"
                                   required>
                            <button type="button" 
                                    class="btn btn-outline-secondary position-absolute end-0 top-0 h-100"
                                    style="border-top-left-radius: 0; border-bottom-left-radius: 0;"
                                    onclick="togglePassword('id_old_password')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        {% if form.old_password.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.old_password.errors %}
                                    <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Debes ingresar tu contraseña actual para confirmar que eres tú.
                        </div>
                    </div>
                    
                    <!-- Nueva contraseña -->
                    <div class="mb-3">
                        <label for="id_new_password1" class="form-label">
                            <i class="fas fa-lock me-1"></i>Nueva Contraseña
                        </label>
                        <div class="position-relative">
                            <input type="password" 
                                   name="new_password1" 
                                   id="id_new_password1" 
                                   class="form-control {% if form.new_password1.errors %}is-invalid{% endif %}"
                                   placeholder="Ingresa tu nueva contraseña"
                                   required>
                            <button type="button" 
                                    class="btn btn-outline-secondary position-absolute end-0 top-0 h-100"
                                    style="border-top-left-radius: 0; border-bottom-left-radius: 0;"
                                    onclick="togglePassword('id_new_password1')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        {% if form.new_password1.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.new_password1.errors %}
                                    <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Mínimo 8 caracteres. No puede ser muy común.
                        </div>
                    </div>
                    
                    <!-- Confirmar nueva contraseña -->
                    <div class="mb-4">
                        <label for="id_new_password2" class="form-label">
                            <i class="fas fa-lock me-1"></i>Confirmar Nueva Contraseña
                        </label>
                        <div class="position-relative">
                            <input type="password" 
                                   name="new_password2" 
                                   id="id_new_password2" 
                                   class="form-control {% if form.new_password2.errors %}is-invalid{% endif %}"
                                   placeholder="Confirma tu nueva contraseña"
                                   required>
                            <button type="button" 
                                    class="btn btn-outline-secondary position-absolute end-0 top-0 h-100"
                                    style="border-top-left-radius: 0; border-bottom-left-radius: 0;"
                                    onclick="togglePassword('id_new_password2')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        {% if form.new_password2.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.new_password2.errors %}
                                    <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Indicador de fortaleza de contraseña -->
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="fas fa-shield-alt me-1"></i>Fortaleza de la Contraseña
                        </label>
                        <div class="password-strength">
                            <div class="strength-bar">
                                <div class="strength-fill" id="strengthFill"></div>
                            </div>
                            <div class="strength-text" id="strengthText">Ingresa una contraseña</div>
                        </div>
                        <div class="strength-requirements mt-2">
                            <small class="text-muted">
                                <i class="fas fa-check-circle me-1" id="lengthCheck"></i>Mínimo 8 caracteres<br>
                                <i class="fas fa-check-circle me-1" id="uppercaseCheck"></i>Al menos una mayúscula<br>
                                <i class="fas fa-check-circle me-1" id="lowercaseCheck"></i>Al menos una minúscula<br>
                                <i class="fas fa-check-circle me-1" id="numberCheck"></i>Al menos un número<br>
                                <i class="fas fa-check-circle me-1" id="specialCheck"></i>Al menos un carácter especial
                            </small>
                        </div>
                    </div>
                    
                    <!-- Botón de cambio de contraseña -->
                    <div class="d-grid mb-3">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                            <i class="fas fa-save me-2"></i>Cambiar Contraseña
                        </button>
                    </div>
                    
                    <!-- Enlaces adicionales -->
                    <div class="text-center">
                        <p class="mb-0">
                            <a href="{% url 'app:profile' %}" class="text-decoration-none">
                                <i class="fas fa-arrow-left me-1"></i>Volver al Perfil
                            </a>
                        </p>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Información de seguridad -->
        <div class="text-center mt-4">
            <div class="alert alert-warning">
                <h6 class="alert-heading">
                    <i class="fas fa-exclamation-triangle me-2"></i>Consejos de Seguridad
                </h6>
                <ul class="mb-0 text-start">
                    <li>No uses la misma contraseña en múltiples sitios</li>
                    <li>Evita información personal como fechas de nacimiento</li>
                    <li>Considera usar un gestor de contraseñas</li>
                    <li>Cambia tu contraseña regularmente</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Función para mostrar/ocultar contraseña
    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const icon = input.nextElementSibling.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.className = 'fas fa-eye-slash';
        } else {
            input.type = 'password';
            icon.className = 'fas fa-eye';
        }
    }
    
    // Función para validar fortaleza de contraseña
    function validatePasswordStrength(password) {
        const checks = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /[0-9]/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };
        
        const score = Object.values(checks).filter(Boolean).length;
        const strengthFill = document.getElementById('strengthFill');
        const strengthText = document.getElementById('strengthText');
        const submitBtn = document.getElementById('submitBtn');
        
        // Actualizar barra de fortaleza
        strengthFill.style.width = (score * 20) + '%';
        
        // Actualizar colores y texto
        if (score <= 1) {
            strengthFill.style.backgroundColor = '#dc3545';
            strengthText.textContent = 'Muy débil';
            strengthText.style.color = '#dc3545';
        } else if (score <= 2) {
            strengthFill.style.backgroundColor = '#fd7e14';
            strengthText.textContent = 'Débil';
            strengthText.style.color = '#fd7e14';
        } else if (score <= 3) {
            strengthFill.style.backgroundColor = '#ffc107';
            strengthText.textContent = 'Media';
            strengthText.style.color = '#ffc107';
        } else if (score <= 4) {
            strengthFill.style.backgroundColor = '#20c997';
            strengthText.textContent = 'Fuerte';
            strengthText.style.color = '#20c997';
        } else {
            strengthFill.style.backgroundColor = '#28a745';
            strengthText.textContent = 'Muy fuerte';
            strengthText.style.color = '#28a745';
        }
        
        // Actualizar checkboxes de requisitos
        document.getElementById('lengthCheck').className = checks.length ? 'fas fa-check-circle text-success' : 'fas fa-times-circle text-danger';
        document.getElementById('uppercaseCheck').className = checks.uppercase ? 'fas fa-check-circle text-success' : 'fas fa-times-circle text-danger';
        document.getElementById('lowercaseCheck').className = checks.lowercase ? 'fas fa-check-circle text-success' : 'fas fa-times-circle text-danger';
        document.getElementById('numberCheck').className = checks.number ? 'fas fa-check-circle text-success' : 'fas fa-times-circle text-danger';
        document.getElementById('specialCheck').className = checks.special ? 'fas fa-check-circle text-success' : 'fas fa-times-circle text-danger';
        
        // Habilitar/deshabilitar botón de envío
        submitBtn.disabled = score < 3;
        
        return score;
    }
    
    // Función para validar que las contraseñas coincidan
    function validatePasswordMatch() {
        const password1 = document.getElementById('id_new_password1');
        const password2 = document.getElementById('id_new_password2');
        const submitBtn = document.getElementById('submitBtn');
        
        if (password1.value && password2.value) {
            if (password1.value !== password2.value) {
                password2.setCustomValidity('Las contraseñas no coinciden');
                submitBtn.disabled = true;
            } else {
                password2.setCustomValidity('');
                // Solo habilitar si la fortaleza es suficiente
                const strength = validatePasswordStrength(password1.value);
                submitBtn.disabled = strength < 3;
            }
        }
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        const password1 = document.getElementById('id_new_password1');
        const password2 = document.getElementById('id_new_password2');
        const oldPassword = document.getElementById('id_old_password');
        
        // Validar fortaleza en tiempo real
        password1.addEventListener('input', function() {
            validatePasswordStrength(this.value);
            validatePasswordMatch();
        });
        
        // Validar coincidencia en tiempo real
        password2.addEventListener('input', validatePasswordMatch);
        
        // Validar campos requeridos
        [oldPassword, password1, password2].forEach(input => {
            input.addEventListener('blur', function() {
                if (this.value.trim() === '') {
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            });
        });
        
        // Validar al enviar el formulario
        document.querySelector('form').addEventListener('submit', function(e) {
            let isValid = true;
            
            [oldPassword, password1, password2].forEach(input => {
                if (input.value.trim() === '') {
                    input.classList.add('is-invalid');
                    isValid = false;
                }
            });
            
            if (password1.value !== password2.value) {
                password2.classList.add('is-invalid');
                isValid = false;
            }
            
            if (!isValid) {
                e.preventDefault();
                alert('Por favor, completa todos los campos correctamente.');
            }
        });
    });
</script>
{% endblock %} 