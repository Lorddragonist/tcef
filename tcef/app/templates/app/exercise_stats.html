{% extends 'app/base.html' %}
{% load static %}

{% block title %}Estadísticas - TCEF{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'app/css/exercise_calendar.css' %}">
<style>
    .stats-container {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }
    
    .stats-header {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }
    
    .stats-component {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }
    
    .stats-component:hover {
        transform: translateY(-5px);
    }
    
    .component-title {
        color: var(--primary-color);
        font-weight: 700;
        margin-bottom: 1rem;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 0.5rem;
    }
    
    .placeholder-component {
        text-align: center;
        color: var(--secondary-color);
        padding: 3rem 1rem;
        border: 2px dashed var(--border-color);
        border-radius: 10px;
    }

    .row .col-md-4 {
        display: flex;
        flex-direction: column;
        justify-items: center;
        justify-content: center;
        align-items: center;
        padding: 0px 40px;
        gap: 10px;
    }

    .row .col-md-4 .btn{
        width: 100%;
        padding: 12px 0px;
        margin: 0px;
        color: #fdfdfd !important; /* Cambiar a negro */
    }

    .row .col-md-4 .me-2{
        color: #000 !important;
    }

    .me-2{
        margin: 0px!important;
    }

    .fas {
        margin-right: 8px!important;
    }

    .streak-stat {
        background: linear-gradient(135deg, #e1cfc6, #b3a5a5);
        color: white;
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        margin-bottom: 1rem;
    }

    .streak-number {
        font-size: 3rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: #716e6e !important; /* Cambiar a negro */
    }

    .streak-label {
        font-size: 1.1rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }

    .stat-item {
        padding: 1rem 0.5rem;
    }

    .stat-number-small {
        font-size: 1.8rem;
        font-weight: bold;
        color: #e1cfc6;
        margin-bottom: 0.25rem;
    }

    .stat-label-small {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .metric-circle {
        width: 80px;
        height: 80px;
        border: 3px solid #e1cfc6;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        transition: all 0.3s ease;
    }

    .metric-circle:hover {
        transform: scale(1.05);
        border-color: #b3a5a5;
        box-shadow: 0 4px 15px rgba(225, 207, 198, 0.3);
    }

    .metric-number {
        font-size: 1.5rem;
        font-weight: bold;
        color: #e1cfc6;
        line-height: 1;
    }

    .metric-label {
        font-size: 0.7rem;
        color: #6c757d;
        text-align: center;
        margin-top: 0.25rem;
    }

    .progress-section {
        background: #f8f9fa;
        padding: 2rem;
        border-radius: 15px;
        border: 1px solid #e9ecef;
    }

    .progress {
        border-radius: 20px;
        background-color: #e9ecef;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .progress-bar.bg-success {
        background: linear-gradient(135deg, #28a745, #20c997) !important;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: width 0.6s ease;
    }

    .progress-text {
        color: white;
        font-weight: bold;
        font-size: 1.1rem;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .progress-info {
        text-align: center;
    }

    .progress-info h5 {
        color: #28a745;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }

    .difficulty-legend {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-bottom: 0.25rem;
    }

    .legend-label {
        font-weight: bold;
        color: #343a40;
        font-size: 0.9rem;
    }

    .legend-count {
        font-size: 1.2rem;
        font-weight: bold;
        color: #e1cfc6;
    }

    #difficultyChart {
        image-rendering: -webkit-optimize-contrast;
        image-rendering: -moz-crisp-edges;
        image-rendering: crisp-edges;
        image-rendering: pixelated;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .body-comp-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease-in-out;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .body-comp-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .body-comp-label {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
        font-weight: 500;
        height: 24px;
    }

    .body-comp-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #343a40;
    }

    /* Reducir altura de cards de macros */
    #nutritionResults .body-comp-card {
        padding: 0.75rem 1rem;
        min-height: auto;
    }

    #nutritionResults .body-comp-label {
        font-size: 0.85rem;
        margin-bottom: 0.25rem;
    }

    #nutritionResults .body-comp-value {
        font-size: 1.4rem;
    }

    /* Estilos para cards de resultados detallados en modal */
    #detailedResults .card {
        border: none;
        box-shadow: none;
        background: transparent;
    }

    #detailedResults .card-body {
        padding: 1rem 0.5rem;
        background: transparent;
        border-radius: 0;
        border: none;
        transition: all 0.2s ease;
    }

    #detailedResults .card-body:hover {
        background: transparent;
        transform: none;
    }

    #detailedResults .card-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    #detailedResults h4 {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
        color: #343a40 !important;
    }

    #detailedResults .text-muted {
        font-size: 0.8rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="stats-container">
    <!-- Header de estadísticas -->
    <div class="stats-header">
        
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="stats-title">
                    <i class="fas fa-chart-bar me-2"></i>Estadísticas de Ejercicios
                </h2>
                <p class="text-muted">Análisis detallado de tu progreso y rendimiento</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{% url 'app:exercise_calendar' %}" class="btn btn-primary me-2">
                    <i class="fas fa-calendar-alt me-1"></i>Volver al Calendario
                </a>
                <a href="{% url 'app:add_measurements' %}" class="btn btn-success">
                    <i class="fas fa-ruler me-1"></i>Registrar Medidas
                </a>
            </div>
        </div>
    </div>

    <!-- Grid de componentes de estadísticas -->
    <div class="stats-grid">
        
        <!-- Componente 1: Progreso Semanal -->
        <div class="stats-component">
            <h4 class="component-title">
                <i class="fas fa-chart-line me-2"></i>Progreso semanal
            </h4>
            
            <!-- Progreso semanal centrado -->
            <div class="progress-section d-flex flex-column justify-content-center align-items-center" style="min-height: 150px;">
                <div class="progress mb-3" style="height: 40px; width: 90%;">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: {{ user_stats.weekly_progress|stringformat:"s" }}%"
                         aria-valuenow="{{ user_stats.weekly_progress|stringformat:"s" }}" 
                         aria-valuemin="0" aria-valuemax="100">
                        <span class="progress-text">{{ user_stats.weekly_progress|stringformat:"s" }}%</span>
                    </div>
                </div>
                <div class="progress-info">
                    <h5 class="mb-1">{{ user_stats.current_week_exercises }} de 5 rutinas</h5>
                    <small class="text-muted">esta semana</small>
                </div>
            </div>
        </div>

        <!-- Componente 2: Racha de Ejercicios -->
        <div class="stats-component">
            <h4 class="component-title">
                <i class="fas fa-fire me-2"></i>Racha de Ejercicios
            </h4>
            
            <!-- Números principales -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="text-center">
                        <div class="streak-number">{{ user_stats.current_streak }}</div>
                        <div class="streak-label">Racha actual</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="text-center">
                        <div class="streak-number">{{ user_stats.longest_streak }}</div>
                        <div class="streak-label">Mejor racha</div>
                    </div>
                </div>
            </div>
            
            <!-- Estadísticas adicionales -->
            <div class="row">
                <div class="col-md-4 text-center">
                    <div class="stat-item">
                        <div class="stat-number-small">{{ user_stats.total_exercises }}</div>
                        <div class="stat-label-small">Total de rutinas</div>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="stat-item">
                        <div class="stat-number-small">{{ user_stats.total_exercises_this_month }}</div>
                        <div class="stat-label-small">Este mes</div>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="stat-item">
                        <div class="stat-number-small">{{ user_stats.progress_percentage|floatformat:0 }}%</div>
                        <div class="stat-label-small">Progreso mensual</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Componente 3: Distribución por Dificultad (mantener como está) -->
        <div class="stats-component">
            <h4 class="component-title">
                <i class="fas fa-layer-group me-2"></i>Por Dificultad
            </h4>
            
            <!-- Gráfico de torta -->
            <div style="height: 300px; width: 100%; position: relative;">
                <canvas id="difficultyChart"></canvas>
            </div>
            
            <!-- Leyenda personalizada -->
            <div class="row mt-3">
                <div class="col-md-4 text-center">
                    <div class="difficulty-legend">
                        <div class="legend-color" style="background-color: #28a745;"></div>
                        <span class="legend-label">Fácil</span>
                        <div class="legend-count" id="facilCount">0</div>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="difficulty-legend">
                        <div class="legend-color" style="background-color: #ffc107;"></div>
                        <span class="legend-label">Medio</span>
                        <div class="legend-count" id="medioCount">0</div>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="difficulty-legend">
                        <div class="legend-color" style="background-color: #dc3545;"></div>
                        <span class="legend-label">Difícil</span>
                        <div class="legend-count" id="dificilCount">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Componente 4: Composición Corporal -->
        <div class="stats-component">
            <h4 class="component-title">
                <i class="fas fa-ruler-combined me-2"></i>Composición Corporal
            </h4>
            
            <div class="row">
                <div class="col-6 mb-3">
                    <div class="body-comp-card">
                        <div class="body-comp-label">IMC</div>
                        <div class="body-comp-value">{{ user_stats.imc|default:"--" }}</div>
                    </div>
                </div>
                <div class="col-6 mb-3">
                    <div class="body-comp-card">
                        <div class="body-comp-label">% GRASA</div>
                        <div class="body-comp-value">{{ user_stats.body_fat_percentage|default:"--" }}</div>
                    </div>
                </div>
                <div class="col-6 mb-3">
                    <div class="body-comp-card">
                        <div class="body-comp-label">M. MÚSCULO</div>
                        <div class="body-comp-value">{{ user_stats.muscle_mass|default:"--" }}</div>
                    </div>
                </div>
                <div class="col-6 mb-3">
                    <div class="body-comp-card">
                        <div class="body-comp-label">ICA</div>
                        <div class="body-comp-value">{{ user_stats.ica|default:"--" }}</div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-3">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Última actualización: {{ user_stats.last_measurement_date|default:"--" }}
                </small>
            </div>
        </div>

        

        <!-- Componente 5: Progreso de Métricas Corporales -->
        <div class="stats-component" style="cursor: pointer;" onclick="openWeightProgressModal()">
            <h4 class="component-title">
                <i class="fas fa-chart-line me-2"></i>Progreso de Métricas Corporales
            </h4>
            <div style="height: 200px; width: 100%; position: relative;">
                <canvas id="weightPreviewChart"></canvas>
            </div>
            
            <!-- Valor actual de masa muscular -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="body-comp-card">
                        <div class="body-comp-label">Masa Muscular Actual</div>
                        <div class="body-comp-value" id="currentMuscleMass">--</div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-2">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Haz clic para ver gráfico completo
                </small>
            </div>
        </div>

        

        

        <!-- Componente 6: Metas y Objetivos -->
        <div class="stats-component" style="cursor: pointer;" onclick="openNutritionModal()">
            <h4 class="component-title">
                <i class="fas fa-bullseye me-2"></i>Metas Nutricionales
            </h4>
            
            <!-- Resultados de cálculos nutricionales -->
            <div id="nutritionResults" style="display: none;">
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="body-comp-card">
                            <div class="body-comp-label">Calorías Objetivo</div>
                            <div class="body-comp-value" id="targetCaloriesResult">--</div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12 mb-2">
                        <div class="body-comp-card">
                            <div class="body-comp-label">Proteína</div>
                            <div class="body-comp-value" id="proteinResult" style="font-size: 1.4rem;">--</div>
                        </div>
                    </div>
                    <div class="col-12 mb-2">
                        <div class="body-comp-card">
                            <div class="body-comp-label">Grasas</div>
                            <div class="body-comp-value" id="fatResult" style="font-size: 1.4rem;">--</div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="body-comp-card">
                            <div class="body-comp-label">Carbohidratos</div>
                            <div class="body-comp-value" id="carbsResult" style="font-size: 1.4rem;">--</div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Haz clic para calcular tus necesidades nutricionales
                    </small>
                </div>
            </div>
            
            <!-- Placeholder cuando no hay cálculos -->
            <div id="nutritionPlaceholder" class="placeholder-component">
                <i class="fas fa-calculator fa-2x mb-3"></i>
                <p>Calculadora de Macros</p>
                <small>Haz clic para calcular tus necesidades nutricionales</small>
            </div>
        </div>

    </div>
</div>

<!-- Modal para gráfico completo de métricas -->
<div class="modal fade" id="weightProgressModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="color: #000 !important;">
                    <i class="fas fa-chart-line me-2"></i>Evolución de Métricas Corporales
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Selector de métrica -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label for="metricSelector" class="form-label">Métrica a Visualizar</label>
                        <select class="form-control" id="metricSelector" onchange="changeMetric()">
                            <option value="muscle_mass">Masa Muscular (kg)</option>
                            <option value="body_fat">% Grasa Corporal</option>
                            <option value="ica">ICA (Índice Cintura-Altura)</option>
                            <option value="weight">Peso (kg)</option>
                            <option value="imc">IMC (Índice de Masa Corporal)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="startDate" class="form-label">Fecha Inicio</label>
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="col-md-3">
                        <label for="endDate" class="form-label">Fecha Fin</label>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="button" class="btn btn-primary me-2" onclick="filterWeightChart()">
                            <i class="fas fa-filter me-1"></i>Filtrar
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetWeightChart()">
                            <i class="fas fa-undo me-1"></i>Reset
                        </button>
                    </div>
                </div>
                
                <!-- Gráfico completo -->
                <div style="height: 400px; width: 100%; position: relative;">
                    <canvas id="weightFullChart"></canvas>
                </div>
                
                <!-- Estadísticas rápidas -->
                <div class="row mt-4">
                    <div class="col-md-3 text-center">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title" id="currentMetricTitle">Valor Actual</h6>
                                <h4 class="text-primary" id="currentWeight">--</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title" id="initialMetricTitle">Valor Inicial</h6>
                                <h4 class="text-info" id="initialWeight">--</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title" id="differenceMetricTitle">Diferencia</h6>
                                <h4 class="text-success" id="weightDifference">--</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title" id="averageMetricTitle">Promedio</h6>
                                <h4 class="text-warning" id="averageWeight">--</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <a href="{% url 'app:add_measurements' %}" class="btn btn-success">
                    <i class="fas fa-plus me-1"></i>Registrar Medidas
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal para cálculo de macros -->
<div class="modal fade" id="nutritionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="color: #000 !important;">
                    <i class="fas fa-calculator me-2"></i>Calculadora de Macros y Calorías
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="nutritionForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="gender" class="form-label">Sexo</label>
                            <select class="form-control" id="gender" required>
                                <option value="">Seleccionar...</option>
                                <option value="male">Hombre</option>
                                <option value="female">Mujer</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="age" class="form-label">Edad (años)</label>
                            <input type="number" class="form-control" id="age" min="15" max="100" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="weight" class="form-label">Peso (kg)</label>
                            <input type="number" class="form-control" id="weight" min="30" max="300" step="0.1" required>
                        </div>
                        <div class="col-md-6">
                            <label for="height" class="form-label">Estatura (cm)</label>
                            <input type="number" class="form-control" id="height" min="120" max="250" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="activityLevel" class="form-label">Nivel de Actividad</label>
                            <select class="form-control" id="activityLevel" required>
                                <option value="">Seleccionar...</option>
                                <option value="1.2">Sedentario (poco/nada de ejercicio)</option>
                                <option value="1.375">Ligero (ejercicio ligero 1-3 días/semana)</option>
                                <option value="1.55">Moderado (ejercicio moderado 3-5 días/semana)</option>
                                <option value="1.725">Activo (ejercicio intenso 6-7 días/semana)</option>
                                <option value="1.9">Muy activo (ejercicio muy intenso, trabajo físico)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="goal" class="form-label">Objetivo</label>
                            <select class="form-control" id="goal" required>
                                <option value="">Seleccionar...</option>
                                <option value="lose">Perder peso (-10% a -20%)</option>
                                <option value="maintain">Mantener peso</option>
                                <option value="gain">Ganar peso (+10% a +20%)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3" id="goalPercentageRow" style="display: none;">
                        <div class="col-md-12">
                            <label for="goalPercentage" class="form-label">Porcentaje de Déficit/Superávit</label>
                            <select class="form-control" id="goalPercentage">
                                <option value="0.10">10%</option>
                                <option value="0.15">15%</option>
                                <option value="0.20">20%</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="proteinRange" class="form-label">Proteína (g por kg de peso)</label>
                            <select class="form-control" id="proteinRange" required>
                                <option value="1.6">1.6 g/kg (mínimo)</option>
                                <option value="1.8">1.8 g/kg (moderado)</option>
                                <option value="2.0">2.0 g/kg (alto)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="fatPercentage" class="form-label">Grasas (% de calorías)</label>
                            <select class="form-control" id="fatPercentage" required>
                                <option value="0.20">20%</option>
                                <option value="0.25">25%</option>
                                <option value="0.30">30%</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="button" class="btn btn-primary me-2" onclick="calculateNutrition()">
                            <i class="fas fa-calculator me-1"></i>Calcular
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearNutritionForm()">
                            <i class="fas fa-eraser me-1"></i>Limpiar
                        </button>
                    </div>
                </form>
                
                <!-- Resultados detallados -->
                <div id="detailedResults" style="display: none;" class="mt-4">
                    <hr>
                    <h6 class="mb-3"><i class="fas fa-chart-pie me-2"></i>Resultados Detallados</h6>
                    
                    <div class="row mb-3">
                        <div class="col-md-12 text-center">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Calorías Objetivo</h6>
                                    <h4 class="text-success" id="detailedTarget">--</h4>
                                    <small class="text-muted">kcal/día</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Proteína</h6>
                                    <h4 class="text-primary" id="detailedProtein">--</h4>
                                    <small class="text-muted">gramos/día</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Grasas</h6>
                                    <h4 class="text-warning" id="detailedFat">--</h4>
                                    <small class="text-muted">gramos/día</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Carbohidratos</h6>
                                    <h4 class="text-success" id="detailedCarbs">--</h4>
                                    <small class="text-muted">gramos/día</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-success" onclick="saveNutritionData()">
                    <i class="fas fa-save me-1"></i>Guardar Configuración
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Datos de las medidas
const measurementsData = {{ measurements_data_json|safe }};
console.log('measurementsData:', measurementsData); // Debug

let weightChart = null;
let weightPreviewChart = null;
let currentMetric = 'muscle_mass'; // Cambiar métrica por defecto a Masa Muscular

// Configuración de métricas
const metricConfig = {
    muscle_mass: {
        label: 'Masa Muscular (kg)',
        color: '#9C27B0',
        backgroundColor: 'rgba(156, 39, 176, 0.1)',
        unit: 'kg',
        currentTitle: 'Masa Muscular Actual',
        initialTitle: 'Masa Muscular Inicial',
        differenceTitle: 'Diferencia',
        averageTitle: 'Promedio'
    },
    body_fat: {
        label: '% Grasa Corporal',
        color: '#FF9800',
        backgroundColor: 'rgba(255, 152, 0, 0.1)',
        unit: '%',
        currentTitle: '% Grasa Actual',
        initialTitle: '% Grasa Inicial',
        differenceTitle: 'Diferencia',
        averageTitle: 'Promedio'
    },
    ica: {
        label: 'ICA',
        color: '#2196F3',
        backgroundColor: 'rgba(33, 150, 243, 0.1)',
        unit: '',
        currentTitle: 'ICA Actual',
        initialTitle: 'ICA Inicial',
        differenceTitle: 'Diferencia',
        averageTitle: 'Promedio'
    },
    weight: {
        label: 'Peso (kg)',
        color: '#e1cfc6',
        backgroundColor: 'rgba(225, 207, 198, 0.1)',
        unit: 'kg',
        currentTitle: 'Peso Actual',
        initialTitle: 'Peso Inicial',
        differenceTitle: 'Diferencia',
        averageTitle: 'Promedio'
    },
    imc: {
        label: 'IMC',
        color: '#4CAF50',
        backgroundColor: 'rgba(76, 175, 80, 0.1)',
        unit: '',
        currentTitle: 'IMC Actual',
        initialTitle: 'IMC Inicial',
        differenceTitle: 'Diferencia',
        averageTitle: 'Promedio'
    }
};

// Funciones para cálculo nutricional
let nutritionData = {};

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, measurementsData:', measurementsData); // Debug
    
    // Inicializar fechas por defecto
    const today = new Date();
    const threeMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());
    
    document.getElementById('startDate').value = threeMonthsAgo.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    
    // Crear gráficos
    createWeightPreviewChart();
    createWeightFullChart();
    createDifficultyChart();
    
    // Calcular estadísticas
    calculateWeightStats();
    
    // Cargar datos guardados de nutrición
    loadNutritionData();
    
    // Actualizar masa muscular actual
    updateCurrentMuscleMass();
    
    // Event listeners para el formulario de nutrición
    document.getElementById('goal').addEventListener('change', function() {
        const goalPercentageRow = document.getElementById('goalPercentageRow');
        if (this.value === 'lose' || this.value === 'gain') {
            goalPercentageRow.style.display = 'block';
        } else {
            goalPercentageRow.style.display = 'none';
        }
    });
});

function createWeightPreviewChart() {
    const ctx = document.getElementById('weightPreviewChart').getContext('2d');
    
    if (measurementsData.labels.length === 0) {
        document.getElementById('weightPreviewChart').parentElement.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-chart-line fa-2x text-muted mb-3"></i>
                <p class="text-muted">No hay datos de métricas</p>
                <small class="text-muted">Registra tu primera medida</small>
            </div>
        `;
        // También actualizar el valor de masa muscular
        document.getElementById('currentMuscleMass').textContent = '--';
        return;
    }
    
    // Mostrar solo los últimos 5 registros
    const recentData = measurementsData.labels.slice(-5);
    const recentWeights = measurementsData.weights.slice(-5);
    
    weightPreviewChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: recentData,
            datasets: [{
                label: 'Peso (kg)',
                data: recentWeights,
                borderColor: '#e1cfc6',
                backgroundColor: 'rgba(225, 207, 198, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    titleFont: { size: 16, weight: 'bold' },
                    bodyFont: { size: 14 },
                    padding: 12,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#e1cfc6',
                    borderWidth: 2
                }
            },
            scales: {
                x: { display: false },
                y: { display: false }
            }
        }
    });
    
    // Actualizar valor actual de masa muscular
    updateCurrentMuscleMass();
}

function createWeightFullChart() {
    const ctx = document.getElementById('weightFullChart').getContext('2d');
    
    if (measurementsData.labels.length === 0) {
        document.getElementById('weightFullChart').parentElement.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No hay datos de métricas</h5>
                <p class="text-muted">Registra tu primera medida para ver tu progreso aquí</p>
                <a href="{% url 'app:add_measurements' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>Registrar Medidas
                </a>
            </div>
        `;
        return;
    }
    
    updateChart();
}

function updateChart() {
    if (!weightChart) return;
    
    const config = metricConfig[currentMetric];
    const data = getCurrentMetricData();
    
    weightChart.data.datasets[0].label = config.label;
    weightChart.data.datasets[0].data = data;
    weightChart.data.datasets[0].borderColor = config.color;
    weightChart.data.datasets[0].backgroundColor = config.backgroundColor;
    
    weightChart.options.scales.y.title.text = config.label;
    
    weightChart.update();
    
    // Actualizar títulos de estadísticas
    document.getElementById('currentMetricTitle').textContent = config.currentTitle;
    document.getElementById('initialMetricTitle').textContent = config.initialTitle;
    document.getElementById('differenceMetricTitle').textContent = config.differenceTitle;
    document.getElementById('averageMetricTitle').textContent = config.averageTitle;
    
    // Recalcular estadísticas
    calculateWeightStats();
}

function getCurrentMetricData() {
    switch(currentMetric) {
        case 'muscle_mass':
            return measurementsData.muscle_masses;
        case 'body_fat':
            return measurementsData.body_fat_percentages;
        case 'ica':
            return measurementsData.icas;
        case 'weight':
            return measurementsData.weights;
        case 'imc':
            return measurementsData.imcs;
        default:
            return measurementsData.muscle_masses; // Por defecto masa muscular
    }
}

function changeMetric() {
    currentMetric = document.getElementById('metricSelector').value;
    updateChart();
}

function createDifficultyChart() {
    const ctx = document.getElementById('difficultyChart').getContext('2d');
    const difficultyData = {{ difficulty_data|safe }};
    
    const totalExercises = difficultyData.facil + difficultyData.medio + difficultyData.dificil;
    
    if (totalExercises === 0) {
        document.getElementById('difficultyChart').parentElement.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-pie-chart fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No hay ejercicios este mes</h5>
                <p class="text-muted">Comienza a ejercitarte para ver tu distribución</p>
            </div>
        `;
        return;
    }
    
    const difficultyChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Fácil', 'Medio', 'Difícil'],
            datasets: [{
                data: [difficultyData.facil, difficultyData.medio, difficultyData.dificil],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                borderColor: '#fff',
                borderWidth: 4,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: { display: false },
                tooltip: {
                    titleFont: { size: 24, weight: 'bold' },
                    bodyFont: { size: 20 },
                    padding: 20,
                    backgroundColor: 'rgba(0, 0, 0, 0.95)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#e1cfc6',
                    borderWidth: 3,
                    cornerRadius: 12,
                    displayColors: false,
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.parsed} ejercicios (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateRotate: true,
                animateScale: false,
                duration: 800
            }
        }
    });
    
    // Actualizar contadores
    document.getElementById('facilCount').textContent = difficultyData.facil;
    document.getElementById('medioCount').textContent = difficultyData.medio;
    document.getElementById('dificilCount').textContent = difficultyData.dificil;
}

function openWeightProgressModal() {
    const modal = new bootstrap.Modal(document.getElementById('weightProgressModal'));
    modal.show();
    
    // Inicializar el gráfico si no existe
    if (!weightChart) {
        const ctx = document.getElementById('weightFullChart').getContext('2d');
        weightChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: measurementsData.labels,
                datasets: [{
                    label: 'Peso (kg)',
                    data: measurementsData.weights,
                    borderColor: '#e1cfc6',
                    backgroundColor: 'rgba(225, 207, 198, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: { size: 14, weight: 'bold' }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        titleFont: { size: 18, weight: 'bold' },
                        bodyFont: { size: 16 },
                        padding: 16,
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#e1cfc6',
                        borderWidth: 2,
                        cornerRadius: 8
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Fecha',
                            font: { size: 14, weight: 'bold' }
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Peso (kg)',
                            font: { size: 14, weight: 'bold' }
                        }
                    }
                }
            }
        });
    }
}

function filterWeightChart() {
    if (!weightChart) return;
    
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) return;
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    const filteredLabels = [];
    const filteredData = [];
    const currentData = getCurrentMetricData();
    
    measurementsData.labels.forEach((label, index) => {
        const labelDate = new Date(label);
        if (labelDate >= start && labelDate <= end) {
            filteredLabels.push(label);
            filteredData.push(currentData[index]);
        }
    });
    
    weightChart.data.labels = filteredLabels;
    weightChart.data.datasets[0].data = filteredData;
    weightChart.update();
}

function resetWeightChart() {
    if (!weightChart) return;
    
    weightChart.data.labels = measurementsData.labels;
    weightChart.data.datasets[0].data = getCurrentMetricData();
    weightChart.update();
}

function calculateWeightStats() {
    console.log('Calculating stats, measurementsData:', measurementsData); // Debug
    
    const currentData = getCurrentMetricData();
    const config = metricConfig[currentMetric];
    
    if (currentData.length === 0) {
        console.log('No data available'); // Debug
        return;
    }
    
    const current = currentData[currentData.length - 1];
    const initial = currentData[0];
    const difference = current - initial;
    const average = currentData.reduce((a, b) => a + b, 0) / currentData.length;
    
    console.log('Stats calculated:', { current, initial, difference, average }); // Debug
    
    const unit = config.unit;
    document.getElementById('currentWeight').textContent = current.toFixed(1) + (unit ? ' ' + unit : '');
    document.getElementById('initialWeight').textContent = initial.toFixed(1) + (unit ? ' ' + unit : '');
    document.getElementById('weightDifference').textContent = (difference >= 0 ? '+' : '') + difference.toFixed(1) + (unit ? ' ' + unit : '');
    document.getElementById('averageWeight').textContent = average.toFixed(1) + (unit ? ' ' + unit : '');
}

function openNutritionModal() {
    const modal = new bootstrap.Modal(document.getElementById('nutritionModal'));
    modal.show();
}

function calculateNutrition() {
    const form = document.getElementById('nutritionForm');
    
    // Validar formulario
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Obtener valores del formulario
    const gender = document.getElementById('gender').value;
    const age = parseInt(document.getElementById('age').value);
    const weight = parseFloat(document.getElementById('weight').value);
    const height = parseInt(document.getElementById('height').value);
    const activityLevel = parseFloat(document.getElementById('activityLevel').value);
    const goal = document.getElementById('goal').value;
    const goalPercentage = parseFloat(document.getElementById('goalPercentage').value) || 0;
    const proteinRange = parseFloat(document.getElementById('proteinRange').value);
    const fatPercentage = parseFloat(document.getElementById('fatPercentage').value);
    
    // Calcular TMB usando Mifflin-St Jeor
    let tmb;
    if (gender === 'male') {
        tmb = (10 * weight) + (6.25 * height) - (5 * age) + 5;
    } else {
        tmb = (10 * weight) + (6.25 * height) - (5 * age) - 161;
    }
    
    // Calcular TDEE
    const tdee = tmb * activityLevel;
    
    // Calcular calorías objetivo
    let targetCalories;
    switch (goal) {
        case 'lose':
            targetCalories = tdee * (1 - goalPercentage);
            break;
        case 'gain':
            targetCalories = tdee * (1 + goalPercentage);
            break;
        case 'maintain':
        default:
            targetCalories = tdee;
            break;
    }
    
    // Calcular macros
    const protein = weight * proteinRange; // gramos
    const proteinCalories = protein * 4; // 4 kcal por gramo
    
    const fatCalories = targetCalories * fatPercentage;
    const fat = fatCalories / 9; // 9 kcal por gramo
    
    const carbsCalories = targetCalories - proteinCalories - fatCalories;
    const carbs = carbsCalories / 4; // 4 kcal por gramo
    
    // Guardar resultados
    nutritionData = {
        tmb: Math.round(tmb),
        tdee: Math.round(tdee),
        targetCalories: Math.round(targetCalories),
        protein: Math.round(protein),
        fat: Math.round(fat),
        carbs: Math.round(carbs),
        gender,
        age,
        weight,
        height,
        activityLevel,
        goal,
        goalPercentage,
        proteinRange,
        fatPercentage
    };
    
    // Mostrar resultados
    updateNutritionDisplay();
    
    // Mostrar resultados detallados en el modal
    document.getElementById('detailedTarget').textContent = nutritionData.targetCalories;
    document.getElementById('detailedProtein').textContent = nutritionData.protein;
    document.getElementById('detailedFat').textContent = nutritionData.fat;
    document.getElementById('detailedCarbs').textContent = nutritionData.carbs;
    
    document.getElementById('detailedResults').style.display = 'block';
}

function updateNutritionDisplay() {
    if (nutritionData.tmb) {
        // Actualizar componente principal
        document.getElementById('targetCaloriesResult').textContent = nutritionData.targetCalories + ' kcal';
        document.getElementById('proteinResult').textContent = nutritionData.protein + 'g';
        document.getElementById('fatResult').textContent = nutritionData.fat + 'g';
        document.getElementById('carbsResult').textContent = nutritionData.carbs + 'g';
        
        // Mostrar resultados y ocultar placeholder
        document.getElementById('nutritionResults').style.display = 'block';
        document.getElementById('nutritionPlaceholder').style.display = 'none';
    }
}

function clearNutritionForm() {
    document.getElementById('nutritionForm').reset();
    document.getElementById('goalPercentageRow').style.display = 'none';
    document.getElementById('detailedResults').style.display = 'none';
}

function saveNutritionData() {
    if (nutritionData.tmb) {
        localStorage.setItem('tcef_nutrition_data', JSON.stringify(nutritionData));
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('nutritionModal'));
        modal.hide();
    }
    // Si no hay datos, simplemente no hace nada
}

function loadNutritionData() {
    const saved = localStorage.getItem('tcef_nutrition_data');
    if (saved) {
        nutritionData = JSON.parse(saved);
        
        // Cargar valores en el formulario
        document.getElementById('gender').value = nutritionData.gender || '';
        document.getElementById('age').value = nutritionData.age || '';
        document.getElementById('weight').value = nutritionData.weight || '';
        document.getElementById('height').value = nutritionData.height || '';
        document.getElementById('activityLevel').value = nutritionData.activityLevel || '';
        document.getElementById('goal').value = nutritionData.goal || '';
        document.getElementById('goalPercentage').value = nutritionData.goalPercentage || '0.15';
        document.getElementById('proteinRange').value = nutritionData.proteinRange || '1.8';
        document.getElementById('fatPercentage').value = nutritionData.fatPercentage || '0.25';
        
        // Mostrar/ocultar porcentaje según el objetivo
        const goalPercentageRow = document.getElementById('goalPercentageRow');
        if (nutritionData.goal === 'lose' || nutritionData.goal === 'gain') {
            goalPercentageRow.style.display = 'block';
        }
        
        // Actualizar display
        updateNutritionDisplay();
    }
}

function updateCurrentMuscleMass() {
    if (measurementsData.muscle_masses && measurementsData.muscle_masses.length > 0) {
        const currentMuscleMass = measurementsData.muscle_masses[measurementsData.muscle_masses.length - 1];
        document.getElementById('currentMuscleMass').textContent = currentMuscleMass.toFixed(1) + ' kg';
    } else {
        document.getElementById('currentMuscleMass').textContent = '--';
    }
}
</script>
{% endblock %}